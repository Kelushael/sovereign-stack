<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMALLO MESH â€” Sovereign Chat</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#c85000;
  --sidebar:rgba(0,0,0,0.35);
  --bubble-me:#0B84FE;
  --bubble-axis:#34C759;
  --system:#FFD60A;
  --input-bg:rgba(0,0,0,0.4);
  --panel-bg:rgba(0,0,0,0.55);
  --font:'Courier New',monospace;
}
html,body{height:100%;overflow:hidden;background:var(--bg);font-family:var(--font);color:#fff}

/* â”€â”€ SCANLINES â”€â”€ */
.scanlines{position:fixed;inset:0;z-index:200;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.07) 2px,rgba(0,0,0,0.07) 4px)}
.vignette{position:fixed;inset:0;z-index:199;pointer-events:none;
  background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,0.6) 100%)}

/* â”€â”€ LAYOUT â”€â”€ */
#app{display:flex;height:100vh;position:relative;z-index:10}

/* â”€â”€ SIDEBAR â”€â”€ */
#sidebar{
  width:180px;min-width:140px;
  background:var(--sidebar);
  border-right:1px solid rgba(255,160,60,0.25);
  display:flex;flex-direction:column;
  padding:12px 0;
  backdrop-filter:blur(4px);
}
#sidebar h2{
  font-size:11px;letter-spacing:2px;color:#FF6B00;
  text-transform:uppercase;padding:0 16px 10px;
  border-bottom:1px solid rgba(255,107,0,0.2);
  margin-bottom:8px;
}
.room-btn{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 16px;cursor:pointer;font-size:13px;
  color:rgba(255,255,255,0.65);transition:all .15s;
  border-left:3px solid transparent;
}
.room-btn:hover{background:rgba(255,107,0,0.12);color:#fff}
.room-btn.active{
  background:rgba(255,107,0,0.2);color:#FF6B00;
  border-left-color:#FF6B00;
}
.room-btn.terminal-room{position:relative}
.room-btn.terminal-room.active{
  color:#34C759;border-left-color:#34C759;
  box-shadow:inset 0 0 20px rgba(52,199,89,0.08);
}
.badge{
  background:rgba(255,107,0,0.4);color:#fff;
  font-size:10px;border-radius:8px;padding:1px 6px;
  min-width:20px;text-align:center;
}
.terminal-room .badge{background:rgba(52,199,89,0.35);color:#34C759}

#sidebar-footer{margin-top:auto;padding:12px 16px;
  font-size:11px;color:rgba(255,255,255,0.35);border-top:1px solid rgba(255,107,0,0.15)}

/* â”€â”€ MAIN CHAT â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;min-width:0}

#chat-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;
  background:rgba(0,0,0,0.25);
  border-bottom:1px solid rgba(255,160,60,0.2);
  backdrop-filter:blur(4px);
}
#chat-header h3{font-size:15px;color:#FF6B00;letter-spacing:1px}
#user-badge{
  font-size:12px;color:rgba(255,255,255,0.6);
  background:rgba(0,0,0,0.3);padding:4px 12px;border-radius:20px;
}
#status-dot{
  width:8px;height:8px;border-radius:50%;
  background:#FF375F;display:inline-block;margin-right:6px;
  box-shadow:0 0 6px currentColor;
}
#status-dot.connected{background:#34C759}

/* â”€â”€ MESSAGES â”€â”€ */
#messages{
  flex:1;overflow-y:auto;padding:16px 20px;
  display:flex;flex-direction:column;gap:6px;
}
#messages::-webkit-scrollbar{width:4px}
#messages::-webkit-scrollbar-track{background:transparent}
#messages::-webkit-scrollbar-thumb{background:rgba(255,107,0,0.3);border-radius:2px}

.msg-row{display:flex;flex-direction:column;max-width:70%}
.msg-row.me{align-self:flex-end;align-items:flex-end}
.msg-row.other{align-self:flex-start;align-items:flex-start}
.msg-row.axis{align-self:flex-start;align-items:flex-start}

.handle-label{font-size:10px;margin-bottom:3px;opacity:.7;letter-spacing:.5px}
.bubble{
  padding:9px 14px;border-radius:18px;
  font-size:13px;line-height:1.5;word-break:break-word;
  position:relative;max-width:100%;
}
.me .bubble{background:var(--bubble-me);color:#fff;border-bottom-right-radius:4px}
.axis .bubble{background:var(--bubble-axis);color:#fff;border-bottom-left-radius:4px}
.bubble pre,.bubble code{
  background:rgba(0,0,0,0.3);padding:8px;border-radius:8px;
  display:block;overflow-x:auto;font-size:11px;margin-top:4px;
  font-family:'Courier New',monospace;
}
.ts{font-size:9px;opacity:.4;margin-top:2px}

.system-msg{
  align-self:center;font-size:11px;
  color:var(--system);opacity:.7;
  padding:3px 12px;background:rgba(0,0,0,0.2);
  border-radius:20px;margin:2px 0;
  text-align:center;
}

/* â”€â”€ INPUT BAR â”€â”€ */
#input-bar{
  display:flex;gap:8px;padding:12px 20px;
  background:rgba(0,0,0,0.3);
  border-top:1px solid rgba(255,160,60,0.2);
}
#msg-input{
  flex:1;background:var(--input-bg);border:1px solid rgba(255,160,60,0.25);
  color:#fff;padding:10px 16px;border-radius:22px;font-size:13px;
  font-family:var(--font);outline:none;transition:border .2s;
}
#msg-input:focus{border-color:rgba(255,107,0,0.6)}
#msg-input:disabled{opacity:.4}
#send-btn{
  background:#FF6B00;border:none;color:#fff;
  padding:10px 20px;border-radius:22px;cursor:pointer;
  font-size:13px;font-family:var(--font);
  transition:background .15s;letter-spacing:.5px;
}
#send-btn:hover{background:#e55c00}
#send-btn:disabled{opacity:.4;cursor:default}

/* â”€â”€ CONNECT OVERLAY â”€â”€ */
#connect-overlay{
  position:fixed;inset:0;z-index:500;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);
}
#connect-panel{
  background:var(--panel-bg);
  border:1px solid rgba(255,107,0,0.4);
  border-radius:16px;padding:32px 40px;
  width:340px;box-shadow:0 0 60px rgba(200,80,0,0.4);
}
#connect-panel h2{
  color:#FF6B00;font-size:18px;letter-spacing:2px;
  text-align:center;margin-bottom:24px;
}
.field{margin-bottom:16px}
.field label{font-size:11px;color:rgba(255,255,255,0.5);
  display:block;margin-bottom:6px;letter-spacing:1px;text-transform:uppercase}
.field input{
  width:100%;background:rgba(0,0,0,0.4);
  border:1px solid rgba(255,160,60,0.3);color:#fff;
  padding:10px 14px;border-radius:10px;font-size:14px;
  font-family:var(--font);outline:none;
}
.field input:focus{border-color:#FF6B00}
#connect-btn{
  width:100%;background:#FF6B00;border:none;color:#fff;
  padding:12px;border-radius:10px;font-size:15px;
  cursor:pointer;font-family:var(--font);letter-spacing:1px;
  margin-top:8px;transition:background .15s;
}
#connect-btn:hover{background:#e55c00}
#connect-error{color:#FF375F;font-size:12px;text-align:center;min-height:18px;margin-top:8px}
</style>
</head>
<body>
<div class="scanlines"></div>
<div class="vignette"></div>

<!-- CONNECT OVERLAY -->
<div id="connect-overlay">
  <div id="connect-panel">
    <h2>âš¡ AMALLO MESH</h2>
    <div class="field">
      <label>Handle</label>
      <input id="inp-handle" type="text" placeholder="your handle" maxlength="24" autocomplete="off">
    </div>
    <div class="field">
      <label>Secret</label>
      <input id="inp-secret" type="password" placeholder="mesh secret" value="amallo">
    </div>
    <div class="field">
      <label>Room</label>
      <select id="inp-room" style="width:100%;background:rgba(0,0,0,0.4);border:1px solid rgba(255,160,60,0.3);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;font-family:var(--font);outline:none">
        <option value="general">#general</option>
        <option value="dev">#dev</option>
        <option value="terminal">âš¡ #terminal</option>
      </select>
    </div>
    <button id="connect-btn">CONNECT</button>
    <div id="connect-error"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app">
  <div id="sidebar">
    <h2>â¬¡ MESH</h2>
    <div class="room-btn active" data-room="general" onclick="switchRoom('general')">
      # general <span class="badge" id="badge-general">0</span>
    </div>
    <div class="room-btn" data-room="dev" onclick="switchRoom('dev')">
      # dev <span class="badge" id="badge-dev">0</span>
    </div>
    <div class="room-btn terminal-room" data-room="terminal" onclick="switchRoom('terminal')">
      âš¡ terminal <span class="badge" id="badge-terminal">0</span>
    </div>
    <div id="sidebar-footer">sovereign stack<br>amallo mesh v1</div>
  </div>

  <div id="main">
    <div id="chat-header">
      <h3><span id="room-title"># general</span></h3>
      <div>
        <span id="status-dot"></span>
        <span id="user-badge">â€”</span>
      </div>
    </div>
    <div id="messages"></div>
    <div id="input-bar">
      <input id="msg-input" type="text" placeholder="Message..." disabled maxlength="2000" autocomplete="off">
      <button id="send-btn" disabled>SEND</button>
    </div>
  </div>
</div>

<script>
const HANDLE_COLORS = ['#34C759','#FF9F0A','#BF5AF2','#FF375F','#5AC8FA'];
let ws = null, myHandle = null, currentRoom = 'general', reconnectTimer = null;
let joinHandle = '', joinSecret = '', joinRoom = 'general';

function hashColor(str){
  let h = 0;
  for(let i=0;i<str.length;i++) h = (h*31+str.charCodeAt(i))&0xffff;
  return HANDLE_COLORS[h % HANDLE_COLORS.length];
}

function fmtTime(ts){
  const d = new Date(ts);
  return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
}

function escHtml(t){
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderText(text){
  // code fences â†’ <pre>
  let html = escHtml(text);
  html = html.replace(/```[\w]*\n?([\s\S]*?)```/g, (_,c)=>`<pre>${c.trim()}</pre>`);
  html = html.replace(/`([^`]+)`/g, (_,c)=>`<code>${c}</code>`);
  html = html.replace(/\n/g,'<br>');
  return html;
}

function addMsg(data){
  const msgs = document.getElementById('messages');
  if(data.type === 'system'){
    const el = document.createElement('div');
    el.className = 'system-msg';
    el.textContent = data.text;
    msgs.appendChild(el);
  } else if(data.type === 'msg'){
    const isMe   = data.handle === myHandle;
    const isAxis = data.axis || data.handle === '[AXIS]';
    const row = document.createElement('div');
    row.className = 'msg-row ' + (isMe ? 'me' : isAxis ? 'axis' : 'other');

    if(!isMe){
      const lbl = document.createElement('div');
      lbl.className = 'handle-label';
      lbl.textContent = data.handle;
      lbl.style.color = isAxis ? '#34C759' : hashColor(data.handle);
      row.appendChild(lbl);
    }

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    if(!isMe && !isAxis) bubble.style.background = hashColor(data.handle);
    bubble.innerHTML = renderText(data.text);

    const ts = document.createElement('div');
    ts.className = 'ts';
    ts.textContent = fmtTime(data.ts || Date.now());
    row.appendChild(bubble);
    row.appendChild(ts);
    msgs.appendChild(row);
  }
  msgs.scrollTop = msgs.scrollHeight;
}

function setRoom(room){
  currentRoom = room;
  document.querySelectorAll('.room-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.room === room);
  });
  const title = room === 'terminal' ? 'âš¡ terminal' : '# ' + room;
  document.getElementById('room-title').textContent = title;
  document.getElementById('messages').innerHTML = '';
}

function switchRoom(room){
  if(!ws || ws.readyState !== WebSocket.OPEN) return;
  if(room === currentRoom) return;
  ws.send(JSON.stringify({type:'switch', room}));
  setRoom(room);
}

function fetchBadges(){
  fetch('/api/rooms').then(r=>r.json()).then(data=>{
    for(const [r,cnt] of Object.entries(data)){
      const el = document.getElementById('badge-'+r);
      if(el) el.textContent = cnt;
    }
  }).catch(()=>{});
}

function connect(){
  joinHandle = document.getElementById('inp-handle').value.trim();
  joinSecret = document.getElementById('inp-secret').value;
  joinRoom   = document.getElementById('inp-room').value;
  const errEl = document.getElementById('connect-error');
  errEl.textContent = '';
  if(!joinHandle){ errEl.textContent = 'Handle required'; return; }

  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);

  ws.onopen = () => {
    ws.send(JSON.stringify({type:'join', handle:joinHandle, secret:joinSecret, room:joinRoom}));
  };

  ws.onmessage = (ev) => {
    let data;
    try{ data = JSON.parse(ev.data); } catch{ return; }

    if(data.type === 'error'){
      document.getElementById('connect-error').textContent = data.text;
      ws.close(); ws = null;
      return;
    }

    // First successful message after join â€” hide overlay
    if(document.getElementById('connect-overlay').style.display !== 'none'){
      document.getElementById('connect-overlay').style.display = 'none';
      myHandle = joinHandle;
      setRoom(joinRoom);
      document.getElementById('user-badge').textContent = 'ðŸ‘¤ ' + myHandle;
      document.getElementById('status-dot').className = 'connected';
      document.getElementById('msg-input').disabled = false;
      document.getElementById('send-btn').disabled = false;
    }

    // Only show messages for current room
    if(data.room && data.room !== currentRoom) return;
    addMsg(data);
  };

  ws.onclose = () => {
    document.getElementById('status-dot').className = '';
    document.getElementById('msg-input').disabled = true;
    document.getElementById('send-btn').disabled = true;
    if(myHandle){
      // reconnect
      clearTimeout(reconnectTimer);
      reconnectTimer = setTimeout(()=>{ reconnectSilent(); }, 3000);
    }
  };

  ws.onerror = (e) => {
    document.getElementById('connect-error').textContent = 'Connection failed';
  };
}

function reconnectSilent(){
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen = () => {
    ws.send(JSON.stringify({type:'join', handle:joinHandle, secret:joinSecret, room:currentRoom}));
  };
  ws.onmessage = (ev) => {
    let data; try{ data=JSON.parse(ev.data); }catch{ return; }
    if(data.type==='error') return;
    if(document.getElementById('status-dot').className !== 'connected'){
      document.getElementById('status-dot').className = 'connected';
      document.getElementById('msg-input').disabled = false;
      document.getElementById('send-btn').disabled = false;
      addMsg({type:'system',text:'reconnected'});
    }
    if(data.room && data.room !== currentRoom) return;
    addMsg(data);
  };
  ws.onclose = () => {
    document.getElementById('status-dot').className = '';
    document.getElementById('msg-input').disabled = true;
    document.getElementById('send-btn').disabled = true;
    clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(reconnectSilent, 5000);
  };
}

function sendMsg(){
  const inp = document.getElementById('msg-input');
  const text = inp.value.trim();
  if(!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({type:'msg', room:currentRoom, text}));
  inp.value = '';
}

document.getElementById('connect-btn').onclick = connect;
document.getElementById('send-btn').onclick     = sendMsg;
document.getElementById('msg-input').addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); }
});
document.getElementById('inp-handle').addEventListener('keydown', e=>{
  if(e.key==='Enter') document.getElementById('connect-btn').click();
});
document.getElementById('inp-secret').addEventListener('keydown', e=>{
  if(e.key==='Enter') document.getElementById('connect-btn').click();
});

// Update badges every 10s
setInterval(fetchBadges, 10000);
fetchBadges();
</script>
</body>
</html>
