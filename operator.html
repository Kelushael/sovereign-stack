<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âš¡ Kernel Mustard â€” Operator Panel</title>
  <style>
    :root {
      --bg: #c85000;
      --panel: rgba(0,0,0,0.35);
      --accent: #FFD60A;
      --blue: #0B84FE;
      --green: #34C759;
      --red: #FF375F;
      --text: #fff;
      --bubble-radius: 14px;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* â”€â”€ TOP BAR â”€â”€ */
    #topbar {
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 10px 20px;
      border-bottom: 2px solid var(--accent);
      flex-shrink: 0;
    }

    #km-title {
      font-weight: 900;
      font-size: 18px;
      color: var(--accent);
      letter-spacing: 2px;
      white-space: nowrap;
    }

    .badge {
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 1px;
      flex-shrink: 0;
    }
    .badge.idle    { background: #3a3a3a; color: #aaa; }
    .badge.running { background: var(--accent); color: #000; animation: pulse 1s infinite; }
    .badge.done    { background: var(--green); color: #fff; }
    .badge.fail    { background: var(--red); color: #fff; }

    #current-url {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      font-family: monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }

    #step-counter {
      font-size: 12px;
      color: var(--accent);
      font-family: monospace;
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* â”€â”€ MAIN SPLIT â”€â”€ */
    #main {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 0;
    }

    /* â”€â”€ LEFT: SCREEN PANEL (60%) â”€â”€ */
    #screen-panel {
      width: 60%;
      display: flex;
      flex-direction: column;
      padding: 12px;
      gap: 8px;
      border-right: 2px solid rgba(0,0,0,0.3);
    }

    #screen-header {
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 2px;
      color: var(--accent);
      opacity: 0.8;
    }

    #screen-wrap {
      position: relative;
      background: #000;
      border: 2px solid var(--accent);
      border-radius: 8px;
      overflow: hidden;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #live-screen {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      cursor: crosshair;
    }

    #screen-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: rgba(255,214,10,0.3);
      pointer-events: none;
    }

    #screen-placeholder .ph-icon { font-size: 48px; }
    #screen-placeholder .ph-text { font-size: 13px; letter-spacing: 1px; }

    #screen-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    /* â”€â”€ RIGHT: LOG + MACROS (40%) â”€â”€ */
    #right-panel {
      width: 40%;
      display: flex;
      flex-direction: column;
      background: var(--panel);
    }

    #tabs {
      display: flex;
      border-bottom: 2px solid rgba(255,214,10,0.2);
      flex-shrink: 0;
    }

    .tab {
      flex: 1;
      background: transparent;
      border: none;
      color: rgba(255,255,255,0.5);
      padding: 10px;
      font-size: 11px;
      font-weight: bold;
      letter-spacing: 1px;
      cursor: pointer;
      transition: color 0.15s, background 0.15s;
    }

    .tab:hover { color: var(--accent); background: rgba(255,214,10,0.05); }
    .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); margin-bottom: -2px; }

    .tab-content { display: none; flex: 1; overflow-y: auto; padding: 10px; }
    .tab-content.active { display: flex; flex-direction: column; }

    /* â”€â”€ ACTION LOG â”€â”€ */
    #action-log {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .log-entry {
      padding: 8px 12px;
      margin: 0;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      color: #fff;
      display: flex;
      gap: 8px;
      align-items: flex-start;
    }

    .step-num  { color: var(--accent); font-weight: bold; flex-shrink: 0; }
    .log-msg   { flex: 1; word-break: break-word; line-height: 1.4; }
    .log-ts    { color: #666; font-size: 10px; margin-left: auto; flex-shrink: 0; padding-top: 2px; }

    /* scroll styling */
    .tab-content::-webkit-scrollbar { width: 4px; }
    .tab-content::-webkit-scrollbar-track { background: transparent; }
    .tab-content::-webkit-scrollbar-thumb { background: rgba(255,214,10,0.3); border-radius: 2px; }

    /* â”€â”€ MACRO PANEL â”€â”€ */
    #macro-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .macro-item {
      background: rgba(0,0,0,0.35);
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(255,214,10,0.15);
    }

    .macro-name {
      flex: 1;
      font-size: 13px;
      font-weight: bold;
      color: var(--accent);
    }

    .macro-meta {
      font-size: 11px;
      color: rgba(255,255,255,0.4);
    }

    .macro-item button {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .macro-item button:hover { opacity: 0.8; }

    .empty {
      color: rgba(255,255,255,0.35);
      font-size: 13px;
      text-align: center;
      padding: 30px 20px;
      line-height: 1.8;
    }

    /* â”€â”€ CMD BAR â”€â”€ */
    #cmd-bar {
      background: rgba(0,0,0,0.45);
      border-top: 2px solid var(--accent);
      padding: 12px 16px 10px;
      flex-shrink: 0;
    }

    #cmd-wrap {
      display: flex;
      gap: 10px;
    }

    #cmd-input {
      flex: 1;
      background: rgba(0,0,0,0.5);
      border: 2px solid var(--accent);
      color: var(--accent);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 15px;
      font-family: monospace;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #cmd-input:focus {
      border-color: #fff;
      box-shadow: 0 0 0 2px rgba(255,214,10,0.2);
    }

    #cmd-input::placeholder { color: rgba(255,214,10,0.4); }

    #cmd-btn {
      background: var(--accent);
      color: #000;
      font-weight: bold;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      letter-spacing: 1px;
      transition: opacity 0.15s, transform 0.1s;
      white-space: nowrap;
    }

    #cmd-btn:hover  { opacity: 0.88; }
    #cmd-btn:active { transform: scale(0.97); }
    #cmd-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    #cmd-options {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
    }

    #cmd-options label { display: flex; align-items: center; gap: 6px; cursor: pointer; }
    #cmd-options input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }

    #macro-name {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,214,10,0.4);
      color: var(--accent);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-family: monospace;
      outline: none;
    }

    #macro-name::placeholder { color: rgba(255,214,10,0.3); }

    /* â”€â”€ RIPPLE â”€â”€ */
    .ripple {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      animation: ripple-out 0.5s ease-out forwards;
      pointer-events: none;
    }

    /* â”€â”€ ANIMATIONS â”€â”€ */
    @keyframes ripple-out {
      from { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      to   { transform: translate(-50%, -50%) scale(3); opacity: 0; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.6; }
    }

    @keyframes slide-in {
      from { opacity: 0; transform: translateX(20px); }
      to   { opacity: 1; transform: translateX(0); }
    }
  </style>
</head>
<body>
<div id="app">

  <div id="topbar">
    <span id="km-title">âš¡ KERNEL MUSTARD</span>
    <span id="status-badge" class="badge idle">IDLE</span>
    <span id="current-url">No page loaded</span>
    <span id="step-counter">0 steps</span>
  </div>

  <div id="main">
    <div id="screen-panel">
      <div id="screen-header">ðŸ–¥ LIVE VIEW</div>
      <div id="screen-wrap">
        <img id="live-screen" src="" alt="Browser view">
        <div id="screen-placeholder">
          <div class="ph-icon">ðŸ–¥</div>
          <div class="ph-text">AWAITING BROWSER SESSION</div>
        </div>
        <div id="screen-overlay"><!-- click coordinate ripples --></div>
      </div>
    </div>

    <div id="right-panel">
      <div id="tabs">
        <button class="tab active" data-tab="log">ACTION LOG</button>
        <button class="tab" data-tab="macros">MACROS</button>
      </div>
      <div id="log-panel" class="tab-content active">
        <div id="action-log"></div>
      </div>
      <div id="macros-panel" class="tab-content">
        <div id="macro-list"></div>
      </div>
    </div>
  </div>

  <div id="cmd-bar">
    <div id="cmd-wrap">
      <input id="cmd-input"
             placeholder='Tell Kernel Mustard what to do... "open github and check my notifications"'
             autofocus>
      <button id="cmd-btn">â–¶ RUN</button>
    </div>
    <div id="cmd-options">
      <label><input type="checkbox" id="record-toggle"> Record as macro</label>
      <input id="macro-name" placeholder="macro name" style="display:none">
    </div>
  </div>

</div>

<script>
  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     STATE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let stepCount = 0;
  let screenInterval = null;
  let screenLoaded = false;

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SCREENSHOT POLLING
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function startScreenPoll() {
    screenInterval = setInterval(() => {
      const img = document.getElementById('live-screen');
      const url = `/api/screenshot?t=${Date.now()}`;
      const tmp = new Image();
      tmp.onload = () => {
        img.src = url;
        if (!screenLoaded) {
          screenLoaded = true;
          document.getElementById('screen-placeholder').style.display = 'none';
        }
      };
      tmp.src = url;
    }, 2000);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     STATUS BADGE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setStatus(status) {
    const badge = document.getElementById('status-badge');
    badge.className = 'badge ' + status.toLowerCase();
    badge.textContent = status;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     LOG
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function clearLog() {
    document.getElementById('action-log').innerHTML = '';
  }

  const ACTION_COLORS = {
    navigate:   '#0B84FE',
    click:      '#FF9F0A',
    click_text: '#FF9F0A',
    type:       '#BF5AF2',
    key:        '#5AC8FA',
    done:       '#34C759',
    fail:       '#FF375F',
    scroll:     '#64D2FF',
    wait:       '#98989E',
  };

  function addLogEntry(entry) {
    const actionType = (entry.msg || '').match(/^\[(\d+)\] (\w+)/)?.[2]
                    || (entry.msg || '').match(/^(\w+)/)?.[1]
                    || 'info';

    const color = ACTION_COLORS[actionType] || '#FFD60A';

    const div = document.createElement('div');
    div.className = 'log-entry';
    div.style.borderLeft = `3px solid ${color}`;
    div.style.opacity = '0';
    div.style.transform = 'translateX(20px)';

    const ts = entry.ts
      ? new Date(entry.ts * 1000).toLocaleTimeString()
      : new Date().toLocaleTimeString();

    div.innerHTML = `
      <span class="step-num">[${entry.step ?? 'â€¢'}]</span>
      <span class="log-msg">${escapeHtml(entry.msg || '')}</span>
      <span class="log-ts">${ts}</span>
    `;

    document.getElementById('action-log').appendChild(div);

    requestAnimationFrame(() => {
      div.style.transition = 'all 0.2s ease';
      div.style.opacity = '1';
      div.style.transform = 'translateX(0)';
    });

    div.scrollIntoView({ behavior: 'smooth', block: 'end' });

    stepCount++;
    document.getElementById('step-counter').textContent = `${stepCount} steps`;

    // Promote to done/fail status on terminal events
    if (actionType === 'done') setStatus('DONE');
    if (actionType === 'fail') setStatus('FAIL');
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SSE STREAM READER
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function readSSEStream(resp) {
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop(); // keep incomplete line
      for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith('data:')) {
          const raw = trimmed.slice(5).trim();
          if (!raw || raw === '[DONE]') continue;
          try {
            const entry = JSON.parse(raw);
            addLogEntry(entry);
          } catch {
            // plain text fallback
            addLogEntry({ msg: raw, step: stepCount });
          }
        }
      }
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     COMMAND SUBMISSION
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function runCommand(cmd) {
    const recordToggle = document.getElementById('record-toggle');
    const macroName = recordToggle.checked
      ? document.getElementById('macro-name').value.trim() || null
      : null;

    setStatus('RUNNING');
    clearLog();
    stepCount = 0;
    document.getElementById('step-counter').textContent = '0 steps';
    document.getElementById('cmd-btn').disabled = true;

    addLogEntry({ msg: `â–¶ ${cmd}`, step: 0, ts: Date.now() / 1000 });

    try {
      const resp = await fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cmd, record_as: macroName }),
      });

      if (!resp.ok) {
        addLogEntry({ msg: `HTTP ${resp.status}: ${resp.statusText}`, step: '!', ts: Date.now() / 1000 });
        setStatus('FAIL');
        return;
      }

      await readSSEStream(resp);

      // If status is still RUNNING, mark done
      const badge = document.getElementById('status-badge');
      if (badge.classList.contains('running')) setStatus('DONE');
    } catch (err) {
      addLogEntry({ msg: `Error: ${err.message}`, step: '!', ts: Date.now() / 1000 });
      setStatus('FAIL');
    } finally {
      document.getElementById('cmd-btn').disabled = false;
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MACROS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadMacros() {
    try {
      const macros = await fetch('/api/macros').then(r => r.json());
      const list = document.getElementById('macro-list');
      if (!macros.length) {
        list.innerHTML = '<div class="empty">No macros saved yet.<br>Check "Record as macro" before running a command.</div>';
        return;
      }
      list.innerHTML = macros.map(m => `
        <div class="macro-item">
          <div class="macro-name">ðŸ“¼ ${escapeHtml(m.name)}</div>
          <div class="macro-meta">${m.action_count ?? '?'} actions</div>
          <button onclick="replayMacro(${JSON.stringify(m.name)})">â–¶ RUN</button>
        </div>
      `).join('');
    } catch {
      document.getElementById('macro-list').innerHTML =
        '<div class="empty">Could not load macros â€” is Kernel Mustard running?</div>';
    }
  }

  async function replayMacro(name) {
    setStatus('RUNNING');
    clearLog();
    stepCount = 0;
    document.getElementById('step-counter').textContent = '0 steps';
    document.getElementById('cmd-btn').disabled = true;

    addLogEntry({ msg: `â–¶ Replaying macro: ${name}`, step: 0, ts: Date.now() / 1000 });

    // Switch to log tab
    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
    document.querySelector('[data-tab="log"]').classList.add('active');
    document.getElementById('log-panel').classList.add('active');

    try {
      const resp = await fetch(`/api/macro/run/${encodeURIComponent(name)}`, { method: 'POST' });
      if (!resp.ok) {
        addLogEntry({ msg: `HTTP ${resp.status}: ${resp.statusText}`, step: '!', ts: Date.now() / 1000 });
        setStatus('FAIL');
        return;
      }
      await readSSEStream(resp);
      const badge = document.getElementById('status-badge');
      if (badge.classList.contains('running')) setStatus('DONE');
    } catch (err) {
      addLogEntry({ msg: `Error: ${err.message}`, step: '!', ts: Date.now() / 1000 });
      setStatus('FAIL');
    } finally {
      document.getElementById('cmd-btn').disabled = false;
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     CLICK-ON-SCREENSHOT
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showRipple(x, y) {
    const overlay = document.getElementById('screen-overlay');
    const r = document.createElement('div');
    r.className = 'ripple';
    r.style.left = `${x}px`;
    r.style.top  = `${y}px`;
    overlay.appendChild(r);
    r.addEventListener('animationend', () => r.remove());
  }

  document.getElementById('screen-wrap').addEventListener('click', async (e) => {
    if (!screenLoaded) return;
    const wrap = document.getElementById('screen-wrap');
    const img  = document.getElementById('live-screen');
    const rect = wrap.getBoundingClientRect();

    const scaleX = img.naturalWidth  / img.clientWidth;
    const scaleY = img.naturalHeight / img.clientHeight;
    const x = Math.round((e.clientX - rect.left)  * scaleX);
    const y = Math.round((e.clientY - rect.top)   * scaleY);

    showRipple(e.clientX - rect.left, e.clientY - rect.top);

    addLogEntry({ msg: `click (${x}, ${y})`, step: 'â†’', ts: Date.now() / 1000 });

    try {
      await fetch('/api/command', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cmd: '__direct_action__', action: { type: 'click', x, y } }),
      });
    } catch { /* silent */ }
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     INIT
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  document.addEventListener('DOMContentLoaded', () => {
    startScreenPoll();
    loadMacros();

    // Poll status for URL updates
    setInterval(async () => {
      try {
        const s = await fetch('/api/status').then(r => r.json());
        if (s.browser_url) {
          document.getElementById('current-url').textContent = s.browser_url;
        }
      } catch { /* server not up yet */ }
    }, 3000);

    // Enter key submits
    document.getElementById('cmd-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('cmd-btn').click();
    });

    // Run button
    document.getElementById('cmd-btn').addEventListener('click', () => {
      const cmd = document.getElementById('cmd-input').value.trim();
      if (cmd) {
        runCommand(cmd);
        document.getElementById('cmd-input').value = '';
      }
    });

    // Record toggle shows/hides macro name input
    document.getElementById('record-toggle').addEventListener('change', e => {
      document.getElementById('macro-name').style.display = e.target.checked ? 'inline-block' : 'none';
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
        t.classList.add('active');
        document.getElementById(t.dataset.tab + '-panel').classList.add('active');
        if (t.dataset.tab === 'macros') loadMacros();
      });
    });
  });
</script>
</body>
</html>
