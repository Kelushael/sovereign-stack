#!/bin/bash
# AI Copilot Chat Interface (runs in split pane)

set -e

AMALLO_URL="${AMALLO_URL:-https://axismundi.fun}"
AMALLO_KEY="${AMALLO_KEY:-$(cat ~/.config/amallo/key 2>/dev/null || echo '')}"
CHAT_HISTORY="$HOME/.local/share/amallo/copilot-chat.jsonl"
PROMPT_FILE="$HOME/.local/share/amallo/copilot-prompt.tmp"
CONTEXT_LINES=20  # How many lines of terminal context to grab

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
ORANGE='\033[0;33m'
CYAN='\033[0;36m'
RESET='\033[0m'
DIM='\033[2m'

clear
echo -e "${PURPLE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${RESET}"
echo -e "${PURPLE}â•‘${RESET}   ${CYAN}ðŸ¤– SOVEREIGN AI COPILOT${RESET} ${DIM}[Ctrl+Alt+Space to close]${RESET}   ${PURPLE}â•‘${RESET}"
echo -e "${PURPLE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${RESET}"
echo ""
echo -e "${DIM}Mode: Terminal Context + AI Assistant${RESET}"
echo -e "${DIM}Watching: Main pane for context${RESET}"
echo ""

# Show last 3 chat messages if exist
if [[ -f "$CHAT_HISTORY" ]]; then
    tail -3 "$CHAT_HISTORY" | while read -r line; do
        role=$(echo "$line" | jq -r '.role')
        content=$(echo "$line" | jq -r '.content' | head -c 80)
        if [[ "$role" == "user" ]]; then
            echo -e "${GREEN}You:${RESET} $content..."
        else
            echo -e "${BLUE}AI:${RESET} $content..."
        fi
    done
    echo ""
fi

echo -e "${ORANGE}Ready.${RESET} Type your message (or press Enter for context-aware help)"
echo ""

# â”€â”€ MAIN LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while true; do
    # Read user input
    echo -ne "${GREEN}You >${RESET} "
    read -r USER_INPUT
    
    # If empty, grab context from main pane
    if [[ -z "$USER_INPUT" ]]; then
        # Get terminal context from main pane
        PARENT_PANE=$(tmux list-panes -F '#{pane_id} #{pane_title}' | grep -v "AI-COPILOT" | head -1 | cut -d' ' -f1)
        CONTEXT=$(tmux capture-pane -t "$PARENT_PANE" -p -S -${CONTEXT_LINES} | tail -20)
        
        # Auto-detect what to do with context
        if echo "$CONTEXT" | grep -qi "error\|exception\|fail\|traceback"; then
            USER_INPUT="Debug this error: $CONTEXT"
        elif echo "$CONTEXT" | tail -1 | grep -q "^[a-z_]*$"; then
            # Looks like incomplete command
            PARTIAL=$(echo "$CONTEXT" | tail -1)
            USER_INPUT="Complete this bash command: $PARTIAL"
        else
            USER_INPUT="Help with: $CONTEXT"
        fi
        
        echo -e "${DIM}[Auto-detected request from terminal context]${RESET}"
    fi
    
    # Special commands
    case "$USER_INPUT" in
        /clear)
            clear
            continue
            ;;
        /exit|/quit)
            echo "Goodbye!"
            exit 0
            ;;
        /history)
            cat "$CHAT_HISTORY" | jq -r '"\(.role): \(.content)"' | tail -20
            continue
            ;;
    esac
    
    # Save to history
    echo "{\"role\":\"user\",\"content\":$(echo "$USER_INPUT" | jq -Rs .),\"timestamp\":$(date +%s)}" >> "$CHAT_HISTORY"
    
    # Show thinking indicator
    echo -ne "${BLUE}AI >${RESET} ${DIM}[thinking...]${RESET}\r"
    
    # Call AI
    RESPONSE=$(curl -s --max-time 30 -X POST "$AMALLO_URL/v1/chat/completions" \
        -H "Authorization: Bearer $AMALLO_KEY" \
        -H "Content-Type: application/json" \
        -d "{
            \"model\": \"qwen\",
            \"messages\": [{\"role\":\"user\",\"content\":$(echo "$USER_INPUT" | jq -Rs .)}],
            \"max_tokens\": 500,
            \"temperature\": 0.7
        }" 2>&1)
    
    CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null || echo "Error: No response")
    CONTENT=$(echo "$CONTENT" | sed 's/<|end of response|>//g')
    
    # Save to history
    echo "{\"role\":\"assistant\",\"content\":$(echo "$CONTENT" | jq -Rs .),\"timestamp\":$(date +%s)}" >> "$CHAT_HISTORY"
    
    # Display response with word wrap
    echo -e "${BLUE}AI >${RESET} "
    echo "$CONTENT" | fold -s -w 58 | sed 's/^/      /'
    echo ""
    
    # If response is a command, offer to copy
    if echo "$CONTENT" | grep -qE "^[a-z].*" && [[ $(echo "$CONTENT" | wc -l) -eq 1 ]]; then
        echo -e "${DIM}[Press 'c' to copy, 'x' to execute in main pane]${RESET}"
        read -n 1 -t 5 action 2>/dev/null || action=""
        case "$action" in
            c)
                echo "$CONTENT" | xsel -ib
                echo -e "\n${GREEN}âœ“ Copied to clipboard${RESET}"
                ;;
            x)
                PARENT_PANE=$(tmux list-panes -F '#{pane_id} #{pane_title}' | grep -v "AI-COPILOT" | head -1 | cut -d' ' -f1)
                tmux send-keys -t "$PARENT_PANE" "$CONTENT"
                echo -e "\n${GREEN}âœ“ Sent to terminal (press Enter to execute)${RESET}"
                ;;
        esac
        echo ""
    fi
done
