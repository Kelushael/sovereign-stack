<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMALLO â€” Sovereign Terminal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --orange:#FF6B00;--blue:#89CFF0;--purple:#C084FC;
  --lime:#BEFF00;--dark:#1a0800;--dim:#2a1200;
  --bg:#c85000;
}

html,body{
  height:100%;overflow:hidden;
  background:var(--bg);
  font-family:'Courier New',monospace;
}

/* â”€â”€ CANVAS LAYERS â”€â”€ */
#cosmic-canvas{
  position:fixed;inset:0;z-index:-1;pointer-events:none;
}
#matrix-canvas{
  position:fixed;inset:0;z-index:0;opacity:0.05;pointer-events:none;
}
#particle-canvas{
  position:fixed;inset:0;z-index:1;pointer-events:none;
}

/* â”€â”€ SCANLINES â”€â”€ */
.scanlines{
  position:fixed;inset:0;z-index:100;pointer-events:none;
  background:repeating-linear-gradient(
    0deg,
    transparent,transparent 2px,
    rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px
  );
}

/* â”€â”€ VIGNETTE â”€â”€ */
.vignette{
  position:fixed;inset:0;z-index:99;pointer-events:none;
  background:radial-gradient(ellipse at center,
    transparent 50%,
    rgba(0,0,0,0.7) 100%
  );
}

/* â”€â”€ TERMINAL WRAPPER â”€â”€ */
#app{
  position:relative;z-index:10;
  display:flex;flex-direction:column;
  height:100vh;
  border:1px solid rgba(255,160,60,0.3);
  background:rgba(180,60,0,0.18);
  backdrop-filter:blur(2px);
  box-shadow:
    0 0 80px rgba(255,107,0,0.15),
    inset 0 0 120px rgba(0,0,0,0.3);
  animation:frame-breathe 4s ease-in-out infinite;
}
@keyframes frame-breathe{
  0%,100%{box-shadow:0 0 60px rgba(255,107,0,0.1),inset 0 0 80px rgba(0,0,0,0.25)}
  50%{box-shadow:0 0 120px rgba(255,107,0,0.22),inset 0 0 80px rgba(0,0,0,0.25)}
}

/* â”€â”€ HEADER â”€â”€ */
#header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 20px;
  border-bottom:1px solid rgba(255,140,40,0.2);
  background:rgba(10,3,0,0.82);
  backdrop-filter:blur(20px);
  position:relative;overflow:hidden;
}
#header::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(90deg,
    rgba(255,107,0,0.05) 0%,
    transparent 30%,
    transparent 70%,
    rgba(192,132,252,0.05) 100%
  );
  animation:header-sweep 8s ease-in-out infinite alternate;
}
@keyframes header-sweep{
  0%{opacity:0.5;transform:translateX(-10%)}
  100%{opacity:1;transform:translateX(10%)}
}

.logo-text{
  font-size:18px;font-weight:900;letter-spacing:8px;
  position:relative;z-index:1;
}
.logo-text .l1{color:var(--blue)}
.logo-text .l2{color:var(--purple)}
.logo-text .l3{color:var(--orange)}
.logo-text .l4{color:var(--blue)}
.logo-text .l5{color:var(--lime)}
.logo-text .l6{color:var(--purple)}
.logo-text{
  animation:glitch 6s ease-in-out infinite;
}
@keyframes glitch{
  0%,90%,100%{text-shadow:none;transform:none}
  92%{text-shadow:2px 0 var(--orange),-2px 0 var(--blue);transform:skewX(-1deg)}
  94%{text-shadow:-3px 0 var(--purple),3px 0 var(--lime);transform:skewX(1deg)}
  96%{text-shadow:1px 0 var(--blue),-1px 0 var(--orange);transform:none}
  98%{text-shadow:none;transform:skewX(-0.5deg)}
}

.status-pills{
  display:flex;gap:16px;align-items:center;
  font-size:10px;letter-spacing:2px;
  position:relative;z-index:1;
}
.pill{
  display:flex;align-items:center;gap:6px;
  color:rgba(255,255,255,0.4);
}
.pill .dot{
  width:6px;height:6px;border-radius:50%;
  animation:pill-pulse 2s ease-in-out infinite;
}
.pill.online .dot{background:var(--lime);box-shadow:0 0 8px var(--lime)}
.pill.model .dot{background:var(--purple);box-shadow:0 0 8px var(--purple)}
.pill.key .dot{background:var(--orange);box-shadow:0 0 8px var(--orange)}
@keyframes pill-pulse{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:0.4;transform:scale(0.7)}
}

/* â”€â”€ OUTPUT â”€â”€ */
#output{
  flex:1;overflow-y:auto;
  padding:16px 20px;
  scroll-behavior:smooth;
  background:transparent;
}
#output::-webkit-scrollbar{width:4px}
#output::-webkit-scrollbar-track{background:transparent}
#output::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:2px}

/* â”€â”€ CHAT BUBBLES â”€â”€ */
.line{
  display:inline-block;
  max-width:88%;
  margin-bottom:6px;
  padding:5px 12px;
  border-radius:14px;
  border:1px solid transparent;
  line-height:1.6;font-size:13px;
  animation:line-in 0.15s ease forwards;
  opacity:0;transform:translateY(4px);
  clear:both;
}
@keyframes line-in{
  to{opacity:1;transform:translateY(0)}
}

/* user bubble â€” right, dark on light */
.line.user{
  float:right;clear:both;
  background:rgba(255,220,180,0.92);
  border-color:rgba(255,140,40,0.6);
  color:#1a0500;
  font-weight:bold;
}

/* ai bubble â€” left, light on dark */
.line.ai{
  float:left;clear:both;
  background:rgba(10,4,20,0.88);
  border-color:rgba(192,132,252,0.5);
  color:rgba(255,255,255,0.92);
  border-left:3px solid var(--purple);
  max-width:92%;
}

/* system â€” subtle dark pill */
.line.system{
  float:left;clear:both;
  background:rgba(0,0,0,0.45);
  border-color:rgba(137,207,240,0.2);
  color:rgba(137,207,240,0.7);
  font-size:11px;
}

/* success â€” green on dark */
.line.success{
  float:left;clear:both;
  background:rgba(0,40,10,0.8);
  border-color:rgba(190,255,0,0.4);
  color:var(--lime);
  text-shadow:0 0 8px rgba(190,255,0,0.3);
}

/* error â€” red on dark */
.line.error{
  float:left;clear:both;
  background:rgba(40,0,0,0.85);
  border-color:rgba(255,68,68,0.5);
  color:#FF6666;
}

/* warning â€” orange on dark */
.line.warning{
  float:left;clear:both;
  background:rgba(30,10,0,0.85);
  border-color:rgba(255,107,0,0.45);
  color:var(--orange);
}

/* info â€” dim white on transparent */
.line.info{
  float:left;clear:both;
  background:rgba(0,0,0,0.3);
  border-color:rgba(255,255,255,0.1);
  color:rgba(255,255,255,0.55);
  font-size:11px;
}

/* clearfix after each bubble */
.line::after{content:'';display:table;clear:both}

/* typing cursor in ai responses */
.typing-cursor{
  display:inline-block;width:8px;height:14px;
  background:var(--purple);
  animation:blink 0.7s step-end infinite;
  vertical-align:middle;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* â”€â”€ ASCII ART â”€â”€ */
.ascii-banner{
  color:rgba(255,107,0,0.35);
  font-size:9px;line-height:1.2;
  margin-bottom:16px;
  white-space:pre;
  animation:ascii-breathe 6s ease-in-out infinite;
}
@keyframes ascii-breathe{
  0%,100%{color:rgba(255,107,0,0.25);text-shadow:none}
  50%{color:rgba(255,107,0,0.5);text-shadow:0 0 20px rgba(255,107,0,0.3)}
}

/* â”€â”€ MIC BUTTON â”€â”€ */
#mic-btn{
  background:none;border:none;cursor:pointer;
  width:34px;height:34px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  color:rgba(137,207,240,0.5);
  border:1px solid rgba(137,207,240,0.15);
  transition:all 0.2s;flex-shrink:0;
  font-size:16px;
}
#mic-btn:hover{color:var(--blue);border-color:rgba(137,207,240,0.4);box-shadow:0 0 12px rgba(137,207,240,0.2)}
#mic-btn.listening{
  color:#FF4444;border-color:rgba(255,68,68,0.6);
  box-shadow:0 0 16px rgba(255,68,68,0.4);
  animation:mic-pulse 0.8s ease-in-out infinite;
}
@keyframes mic-pulse{
  0%,100%{box-shadow:0 0 10px rgba(255,68,68,0.3)}
  50%{box-shadow:0 0 25px rgba(255,68,68,0.7),0 0 50px rgba(255,68,68,0.3)}
}

/* â”€â”€ CHAIN BUTTON â”€â”€ */
#chain-btn{
  background:none;border:none;cursor:pointer;
  width:34px;height:34px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  color:rgba(168,85,247,0.4);
  border:1px solid rgba(168,85,247,0.15);
  transition:all 0.2s;flex-shrink:0;
  font-size:15px;
}
#chain-btn:hover{color:rgba(168,85,247,0.8);border-color:rgba(168,85,247,0.4)}
#chain-btn.active{
  color:#a855f7;border-color:rgba(168,85,247,0.7);
  box-shadow:0 0 18px rgba(168,85,247,0.5);
  animation:chain-pulse 1.2s ease-in-out infinite;
}
@keyframes chain-pulse{
  0%,100%{box-shadow:0 0 10px rgba(168,85,247,0.3)}
  50%{box-shadow:0 0 28px rgba(168,85,247,0.7),0 0 50px rgba(168,85,247,0.2)}
}

/* â”€â”€ DOWNLOAD LINK â”€â”€ */
.dl-btn{
  display:inline-flex;align-items:center;gap:5px;
  margin:6px 0 2px 16px;padding:4px 10px;
  background:rgba(190,255,0,0.08);
  border:1px solid rgba(190,255,0,0.3);
  border-radius:4px;color:var(--lime);
  font-size:11px;letter-spacing:1px;cursor:pointer;
  text-decoration:none;font-family:'Courier New',monospace;
  transition:all 0.2s;
}
.dl-btn:hover{background:rgba(190,255,0,0.18);box-shadow:0 0 12px rgba(190,255,0,0.3)}

/* â”€â”€ PLAY BUTTON â”€â”€ */
.play-btn{
  display:inline-flex;align-items:center;justify-content:center;
  margin-left:8px;cursor:pointer;
  width:18px;height:18px;border-radius:50%;
  background:rgba(192,132,252,0.15);
  border:1px solid rgba(192,132,252,0.3);
  color:var(--purple);font-size:8px;
  transition:all 0.2s;vertical-align:middle;
  flex-shrink:0;
}
.play-btn:hover{background:rgba(192,132,252,0.3);box-shadow:0 0 10px rgba(192,132,252,0.4)}
.play-btn.speaking{
  background:rgba(192,132,252,0.3);
  box-shadow:0 0 12px rgba(192,132,252,0.5);
  animation:play-spin 1s linear infinite;
}
@keyframes play-spin{
  0%,100%{box-shadow:0 0 8px rgba(192,132,252,0.4)}
  50%{box-shadow:0 0 20px rgba(192,132,252,0.8)}
}

/* â”€â”€ INPUT AREA â”€â”€ */
#input-area{
  padding:12px 20px;
  border-top:1px solid rgba(137,207,240,0.08);
  background:rgba(8,3,10,0.95);
  display:flex;align-items:center;gap:10px;
  position:relative;
}
#input-area::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,
    transparent,var(--orange),var(--purple),var(--lime),transparent
  );
  opacity:0.3;
  animation:input-line 4s linear infinite;
  background-size:200% 100%;
}
@keyframes input-line{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

.prompt-symbol{
  color:var(--lime);font-size:16px;font-weight:bold;
  text-shadow:0 0 10px var(--lime);
  animation:prompt-pulse 2s ease-in-out infinite;
}
@keyframes prompt-pulse{
  0%,100%{text-shadow:0 0 8px var(--lime)}
  50%{text-shadow:0 0 20px var(--lime),0 0 40px rgba(190,255,0,0.3)}
}

#cmd-input{
  flex:1;background:transparent;border:none;outline:none;
  color:var(--blue);font-family:'Courier New',monospace;
  font-size:14px;caret-color:var(--lime);
  text-shadow:0 0 8px rgba(137,207,240,0.4);
}
#cmd-input::placeholder{
  color:rgba(255,255,255,0.1);font-style:italic;font-size:12px;
}
#cmd-input:focus{
  text-shadow:0 0 12px rgba(137,207,240,0.6);
}

/* input glow on typing */
#input-area.typing{
  background:rgba(12,5,18,0.98);
  box-shadow:0 -4px 20px rgba(137,207,240,0.06);
}

/* â”€â”€ MODEL SELECTOR â”€â”€ */
#model-selector{
  display:none;position:absolute;bottom:60px;left:20px;right:20px;
  background:rgba(8,3,10,0.97);
  border:1px solid rgba(192,132,252,0.4);
  border-radius:6px;
  box-shadow:0 0 40px rgba(192,132,252,0.2);
  max-height:280px;overflow-y:auto;
  z-index:200;
}
#model-selector.open{display:block}
.model-selector-header{
  padding:8px 14px;font-size:10px;letter-spacing:2px;
  color:var(--purple);border-bottom:1px solid rgba(192,132,252,0.2);
  display:flex;justify-content:space-between;
}
.model-item{
  display:flex;align-items:center;gap:12px;
  padding:8px 14px;cursor:pointer;
  font-size:13px;color:rgba(255,255,255,0.6);
  border-bottom:1px solid rgba(255,255,255,0.03);
  transition:background 0.1s;
}
.model-item:hover,.model-item.focused{
  background:rgba(192,132,252,0.1);color:rgba(255,255,255,0.9);
}
.model-item.focused{border-left:2px solid var(--purple)}
.model-item .check{
  width:14px;height:14px;border-radius:2px;
  border:1px solid rgba(192,132,252,0.4);
  display:flex;align-items:center;justify-content:center;
  font-size:10px;flex-shrink:0;
}
.model-item.selected .check{
  background:var(--purple);border-color:var(--purple);color:#000;
}
.model-item .badge{
  margin-left:auto;font-size:9px;letter-spacing:1px;
  color:var(--lime);opacity:0.6;
}

/* â”€â”€ NODE INFO BAR â”€â”€ */
#node-bar{
  display:flex;justify-content:space-between;
  padding:4px 20px;
  font-size:9px;letter-spacing:2px;
  color:rgba(255,255,255,0.1);
  border-top:1px solid rgba(255,255,255,0.03);
  background:rgba(0,0,0,0.4);
}
#latency{animation:latency-jitter 3s ease-in-out infinite}
@keyframes latency-jitter{
  0%,100%{content:''}
  50%{color:rgba(190,255,0,0.3)}
}
/* â”€â”€ COMMAND PALETTE â”€â”€ */
#cmd-palette{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
  width:min(640px,92vw);
  background:rgba(6,2,16,0.97);
  border:1px solid rgba(168,85,247,0.45);
  border-radius:10px;
  backdrop-filter:blur(24px);
  z-index:2000;
  display:none;
  max-height:min(420px,60vh);
  overflow-y:auto;
  box-shadow:0 0 40px rgba(168,85,247,0.2);
}
#cmd-palette.open{display:block}
.pal-header{
  padding:.55rem 1rem;
  color:rgba(255,255,255,0.25);
  font-size:.7rem;letter-spacing:2px;
  border-bottom:1px solid rgba(255,255,255,0.05);
  display:flex;justify-content:space-between;align-items:center;
  position:sticky;top:0;background:rgba(6,2,16,0.98);
}
.pal-filter{color:#a855f7;font-size:.8rem;letter-spacing:1px}
.pal-item{
  padding:.55rem 1rem;
  display:flex;gap:1rem;cursor:pointer;align-items:baseline;
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.pal-item:hover,.pal-item.focused{background:rgba(168,85,247,0.13)}
.pal-name{color:#a855f7;min-width:150px;font-weight:bold;font-size:.9rem}
.pal-name.custom{color:#22d3ee}
.pal-desc{color:rgba(255,255,255,0.45);font-size:.82rem;flex:1}
.pal-tag{
  font-size:.65rem;color:rgba(34,211,238,0.6);
  letter-spacing:1px;padding:.1rem .4rem;
  border:1px solid rgba(34,211,238,0.2);border-radius:3px;
  white-space:nowrap;
}
</style>
</head>
<body>

<!-- CANVAS LAYERS -->
<canvas id="matrix-canvas"></canvas>
<canvas id="particle-canvas"></canvas>
<div class="scanlines"></div>
<div class="vignette"></div>

<!-- TERMINAL -->
<div id="app">
  <div id="header">
    <div class="logo-text">
      <span class="l1">A</span><span class="l2">M</span><span class="l3">A</span><span class="l4">L</span><span class="l5">L</span><span class="l6">O</span>
      <span style="color:rgba(255,255,255,0.2);font-size:11px;letter-spacing:4px;margin-left:12px">SOVEREIGN SHELL</span>
    </div>
    <div class="status-pills">
      <div class="pill online"><div class="dot"></div><span>NODE ZERO</span></div>
      <div class="pill model"><div class="dot"></div><span id="model-label">DOLPHIN</span></div>
      <div class="pill key"><div class="dot"></div><span id="latency-label">SOVEREIGN</span></div>
    </div>
  </div>

  <div id="output"></div>

  <div id="model-selector"></div>
  <div id="cmd-palette"></div>
  <div id="input-area">
    <span class="prompt-symbol">â¯</span>
    <input id="cmd-input" type="text" placeholder="awaiting sovereign command..." autocomplete="off" spellcheck="false" autofocus />
    <button id="mic-btn" title="Voice input (hold to speak)">ğŸ™</button>
    <button id="chain-btn" title="Auto-chain: feed AI response back as next prompt (Ctrl+Shift+C)" onclick="toggleChain()">â›“</button>
  </div>

  <div id="node-bar">
    <span>axismundi.fun Â· 76.13.24.113</span>
    <span id="latency">latency: <span id="ms">â€”</span>ms</span>
    <span>amallo-node-0 Â· unbolted</span>
  </div>
</div>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE        = 'https://axismundi.fun';
const BRAIN_URL   = localStorage.getItem('amallo_brain')  || 'http://localhost:8100';
const DIFF_URL    = localStorage.getItem('amallo_diff')   || 'http://localhost:8200';
let SOV_KEY = localStorage.getItem('amallo_key') || '';
let cmdHistory = JSON.parse(localStorage.getItem('amallo_history') || '[]');
let histIdx = -1;
let currentModel = 'dolphin-mistral:latest';
const MODEL_ROUTES = {
  'brain':'brain','auto':'brain',
  'diffusion':DIFF_URL,'llada':DIFF_URL,
  'dolphin':BASE,'mistral':BASE,'glm':BASE,'glm4':BASE,
  'coder':BASE,'deepseek':BASE,'r1':BASE,
};

// â”€â”€ COMMAND REGISTRY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ALL_CMDS = [
  {name:'help',       desc:'show all commands',                       noArgs:true},
  {name:'clear',      desc:'wipe terminal buffer',                    noArgs:true},
  {name:'status',     desc:'node health + model info',                noArgs:true},
  {name:'models',     desc:'list available models',                   noArgs:true},
  {name:'stack',      desc:'full sovereign stack status',             noArgs:true},
  {name:'paradigm',   desc:'AR vs diffusion explained',               noArgs:true},
  {name:'install',    desc:'show one-line install command',           noArgs:true},
  {name:'model',      desc:'switch active model',                     noArgs:false},
  {name:'brain',      desc:'auto-route query by intent',              noArgs:false},
  {name:'diffusion',  desc:'query diffusion LLM (masked/bidirectional)',noArgs:false},
  {name:'getkey',     desc:'generate SOV key for your identity',      noArgs:false},
  {name:'setkey',     desc:'load an existing SOV key',                noArgs:false},
  {name:'save',       desc:'download last AI response as file',       noArgs:false},
  {name:'/addcmd',    desc:'add custom command (just describe what it does)', noArgs:false},
];

// â”€â”€ COMMAND PALETTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let paletteOpen = false;
let paletteIdx  = 0;
let palFiltered = [];
const pal = document.getElementById('cmd-palette');

function buildPaletteItems(filter){
  const customs = Object.entries(customCmds||{}).map(([n,v])=>({
    name:'/'+n, desc:v.action||v, noArgs:false, custom:true
  }));
  const all = [...ALL_CMDS.map(c=>({...c,custom:false})), ...customs];
  const q = (filter||'').toLowerCase().replace(/^\//,'');
  if(!q) return all;
  return all.filter(c=>c.name.toLowerCase().includes(q)||c.desc.toLowerCase().includes(q));
}

function openPalette(filter){
  paletteIdx = 0;
  paletteOpen = true;
  renderPalette(filter);
  pal.classList.add('open');
  document.addEventListener('keydown', paletteKeyHandler);
}

function renderPalette(filter){
  palFiltered = buildPaletteItems(filter);
  const fDisp = filter ? `<span class="pal-filter">/${filter}</span>` : '<span class="pal-filter">/</span>';
  pal.innerHTML = `<div class="pal-header">${fDisp}<span>â†‘â†“ Â· ENTER Â· ESC</span></div>`;
  if(!palFiltered.length){
    pal.innerHTML += `<div class="pal-item"><span class="pal-desc">no match â€” keep typing or ESC</span></div>`;
    return;
  }
  palFiltered.forEach((c,i)=>{
    const div = document.createElement('div');
    div.className = 'pal-item'+(i===paletteIdx?' focused':'');
    div.innerHTML = `<span class="pal-name${c.custom?' custom':''}">${c.name}</span>`+
      `<span class="pal-desc">${c.desc}</span>`+
      (c.custom?`<span class="pal-tag">CUSTOM</span>`:'');
    div.addEventListener('click',()=>{ pickPaletteItem(c); closePalette(); });
    pal.appendChild(div);
  });
}

function closePalette(){
  pal.classList.remove('open');
  paletteOpen = false;
  document.removeEventListener('keydown', paletteKeyHandler);
  input.focus();
}

function pickPaletteItem(item){
  if(item.noArgs){
    input.value = '';
    handleCmd(item.name);
  } else {
    input.value = item.name + ' ';
    inputArea.classList.add('typing');
  }
}

function paletteKeyHandler(e){
  if(!paletteOpen) return;
  if(e.key==='ArrowDown'){
    e.preventDefault();
    paletteIdx = Math.min(paletteIdx+1, palFiltered.length-1);
    _palFocus();
  } else if(e.key==='ArrowUp'){
    e.preventDefault();
    paletteIdx = Math.max(paletteIdx-1, 0);
    _palFocus();
  } else if(e.key==='Enter'){
    e.preventDefault();
    if(palFiltered[paletteIdx]) pickPaletteItem(palFiltered[paletteIdx]);
    closePalette();
  } else if(e.key==='Escape'){
    closePalette();
    input.value = '';
  }
}

function _palFocus(){
  document.querySelectorAll('#cmd-palette .pal-item').forEach((el,i)=>
    el.classList.toggle('focused', i===paletteIdx));
  document.querySelectorAll('#cmd-palette .pal-item')[paletteIdx]?.scrollIntoView({block:'nearest'});
}

// â”€â”€ AUTO-NAME FROM DESCRIPTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoNameCmd(desc){
  const stop = new Set(['a','an','the','and','or','to','for','in','of','on','at',
    'with','that','this','it','is','does','do','runs','shows','gets','make','creates']);
  const words = desc.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/)
    .filter(w=>w.length>2&&!stop.has(w));
  return (words.slice(0,2).join('-'))||desc.slice(0,12).replace(/\s/g,'-');
}

// â”€â”€ MATRIX RAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const mCvs = document.getElementById('matrix-canvas');
const mCtx = mCvs.getContext('2d');
let cols, drops;
function initMatrix(){
  mCvs.width = window.innerWidth;
  mCvs.height = window.innerHeight;
  cols = Math.floor(mCvs.width / 16);
  drops = Array(cols).fill(1);
}
function drawMatrix(){
  mCtx.fillStyle = 'rgba(8,3,10,0.05)';
  mCtx.fillRect(0,0,mCvs.width,mCvs.height);
  const chars = 'ã‚¢ã‚¤ã‚¦ã‚¨ã‚ªã‚«ã‚­ã‚¯ã‚±ã‚³0123456789AMALLOâˆâ¬¡â¬¢';
  drops.forEach((y,i)=>{
    const ch = chars[Math.floor(Math.random()*chars.length)];
    const r = Math.random();
    if(r < 0.33) mCtx.fillStyle='rgba(255,107,0,0.8)';
    else if(r < 0.66) mCtx.fillStyle='rgba(192,132,252,0.8)';
    else mCtx.fillStyle='rgba(190,255,0,0.8)';
    mCtx.font='12px monospace';
    mCtx.fillText(ch, i*16, y*16);
    if(y*16 > mCvs.height && Math.random() > 0.975) drops[i]=0;
    drops[i]++;
  });
}
initMatrix();
setInterval(drawMatrix, 60);

// â”€â”€ PARTICLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pCvs = document.getElementById('particle-canvas');
const pCtx = pCvs.getContext('2d');
const COLORS = ['rgba(255,107,0,','rgba(137,207,240,','rgba(192,132,252,','rgba(190,255,0,'];
let particles = [];
function initParticles(){
  pCvs.width = window.innerWidth;
  pCvs.height = window.innerHeight;
  particles = Array.from({length:60},()=>({
    x: Math.random()*pCvs.width,
    y: Math.random()*pCvs.height,
    vx:(Math.random()-0.5)*0.4,
    vy:(Math.random()-0.5)*0.4,
    r: Math.random()*2+0.5,
    col: COLORS[Math.floor(Math.random()*COLORS.length)],
    a: Math.random()*0.4+0.1,
    pulse: Math.random()*Math.PI*2
  }));
}
function drawParticles(){
  pCtx.clearRect(0,0,pCvs.width,pCvs.height);
  particles.forEach(p=>{
    p.pulse += 0.02;
    const alpha = p.a*(0.6+0.4*Math.sin(p.pulse));
    pCtx.beginPath();
    pCtx.arc(p.x,p.y,p.r,0,Math.PI*2);
    pCtx.fillStyle = p.col+alpha+')';
    pCtx.fill();
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0)p.x=pCvs.width;
    if(p.x>pCvs.width)p.x=0;
    if(p.y<0)p.y=pCvs.height;
    if(p.y>pCvs.height)p.y=0;
  });
}
initParticles();
setInterval(drawParticles, 30);

window.addEventListener('resize',()=>{initMatrix();initParticles()});

// â”€â”€ LATENCY PING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pingLatency(){
  const t = Date.now();
  try{
    await fetch(BASE+'/health',{cache:'no-store'});
    document.getElementById('ms').textContent = Date.now()-t;
  }catch(e){
    document.getElementById('ms').textContent = '?';
  }
}
pingLatency();
setInterval(pingLatency,5000);

// â”€â”€ OUTPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const out = document.getElementById('output');

function addLine(text, type='info', delay=0){
  return new Promise(res=>{
    setTimeout(()=>{
      // wrap in clearfix row so floated bubbles stack vertically
      const row = document.createElement('div');
      row.style.cssText = 'clear:both;overflow:hidden;margin-bottom:2px';
      const d = document.createElement('div');
      d.className = 'line '+type;
      d.textContent = text;
      row.appendChild(d);
      out.appendChild(row);
      out.scrollTop = out.scrollHeight;
      res();
    }, delay);
  });
}

async function typeWriter(text, type='ai'){
  const row = document.createElement('div');
  row.style.cssText = 'clear:both;overflow:hidden;margin-bottom:2px';
  const d = document.createElement('div');
  d.className = 'line '+type;
  d.style.display = 'flex';
  d.style.alignItems = 'flex-start';
  d.style.gap = '8px';

  const textSpan = document.createElement('span');
  textSpan.style.flex = '1';
  const cursor = document.createElement('span');
  cursor.className = 'typing-cursor';

  d.appendChild(textSpan);
  row.appendChild(d);
  out.appendChild(row);
  out.scrollTop = out.scrollHeight;

  for(const ch of text){
    textSpan.textContent += ch;
    textSpan.appendChild(cursor);
    out.scrollTop = out.scrollHeight;
    await new Promise(r=>setTimeout(r, Math.random()*18+4));
  }
  cursor.remove();

  // add play button after typing completes
  const playBtn = document.createElement('button');
  playBtn.className = 'play-btn';
  playBtn.textContent = 'â–¶';
  playBtn.title = 'Read aloud';
  playBtn.style.marginTop = '3px';
  playBtn.addEventListener('click', ()=>speakText(text, playBtn));
  d.appendChild(playBtn);
}

// â”€â”€ BOOT SEQUENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function boot(){
  const ascii = `   _   __  __ _   _    _    _     _    ___
  /_\\ |  \\/  /_\\ | |  | |  / \\   /_\\  / _ \\
 //_\\\\| |\\/| //_\\\\| |__| |_/ _ \\ //_\\ \\_, /
/  _  \\_|  |_/  _  \\____\\____/ \\ \\_/  /_/\\__\\`;
  const pre = document.createElement('pre');
  pre.className='ascii-banner';
  pre.textContent=ascii;
  out.appendChild(pre);

  const msgs = [
    ['AMALLO SOVEREIGN TERMINAL v2.0.0','system'],
    ['','system'],
    ['Initializing node identity...','info'],
    ['  âœ” Node: amallo-node-0','success'],
    ['  âœ” Host: axismundi.fun (76.13.24.113)','success'],
    ['  âœ” Model: dolphin-mistral loaded','success'],
    ['  âœ” Inference: llama.cpp + GGUF direct','success'],
    ['  âœ” Stack: brain:8100 diffusion:8200 gguf:443','info'],
    ['','info'],
  ];
  for(let i=0;i<msgs.length;i++){
    await addLine(msgs[i][0],msgs[i][1],i*120);
  }

  if(!SOV_KEY){
    await addLine('  âš  No SOV key found. Type: getkey yourname','warning',msgs.length*120);
  } else {
    await addLine('  âœ” SOV key loaded: '+SOV_KEY.slice(0,12)+'...','success',msgs.length*120);
  }

  setTimeout(async()=>{
    await addLine('','info');
    await addLine('Type help for commands. Type anything to talk to the node.','info');
  }, msgs.length*120+200);
}

// â”€â”€ COMMANDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleCmd(raw){
  const cmd = raw.trim();
  const lower = cmd.toLowerCase();
  addLine('â¯ '+cmd,'user');

  // â”€â”€ DOT MACRO â”€â”€ "." = universal continue/yes/next signal
  // just passes through to inference â€” AI reads it as "continue" or "yes"
  // chain mode fires this automatically x2 on every response arrival

  // local commands
  if(lower==='clear'){out.innerHTML='';return}

  if(lower==='help'){
    const cmds=[
      ['help              ','this menu'],
      ['clear             ','wipe buffer'],
      ['getkey [name]     ','generate your SOV key'],
      ['setkey [SOV-KEY]  ','load existing key'],
      ['status            ','node health + model info'],
      ['model [name]      ','switch model (dolphin/glm/coder/deepseek/brain/diffusion)'],
      ['models            ','list available models'],
      ['brain             ','query amallo-brain router (auto-routes by intent)'],
      ['diffusion [msg]   ','query diffusion LLM directly (LLaDA masked diffusion)'],
      ['paradigm          ','explain AR vs diffusion paradigms'],
      ['stack             ','show full sovereign stack status'],
      ['install           ','show one-line install command'],
      ['save [name]       ','download last AI response as a file'],
      ['/addcmd [n] [cmd] ','create a custom shortcut command'],
      ['[anything else]   ','talk to the sovereign node'],
    ];
    await addLine('â”€â”€ SOVEREIGN COMMANDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    for(const [c,d] of cmds) await addLine('  '+c+d,'info');
    await addLine('â”€â”€ MODELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    await addLine('  dolphin-mistral   chat / fallback  (live)','success');
    await addLine('  glm4              general purpose  (live)','success');
    await addLine('  qwen2.5-coder     code specialist  (deploy-models.sh)','warning');
    await addLine('  deepseek-r1       reasoning/math   (deploy-models.sh)','warning');
    await addLine('  brain             auto-router      (run amallo-brain locally)','info');
    await addLine('  diffusion         LLaDA masked     (run amallo-diffusion locally)','info');
    await addLine('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    return;
  }

  if(lower.startsWith('getkey')){
    const name = cmd.split(' ')[1] || 'user';
    try{
      const r = await fetch(BASE+'/amallo/keys/create',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({identity:name,role:'user'})
      });
      const d = await r.json();
      SOV_KEY = d.key;
      localStorage.setItem('amallo_key',SOV_KEY);
      await addLine('âœ” Key generated for: '+d.identity,'success');
      await addLine('  '+SOV_KEY,'system');
      await addLine('  Saved to browser. Do not lose this.','warning');
    }catch(e){
      await addLine('âœ— Failed: '+e.message,'error');
    }
    return;
  }

  if(lower.startsWith('setkey')){
    SOV_KEY = cmd.split(' ')[1]||'';
    localStorage.setItem('amallo_key',SOV_KEY);
    await addLine('âœ” Key set: '+SOV_KEY.slice(0,16)+'...','success');
    return;
  }

  if(lower==='status'){
    if(!SOV_KEY){await addLine('âœ— No key. Run: getkey yourname','error');return}
    try{
      addLine('Scanning node...','info');
      const r = await fetch(BASE+'/amallo/status',{
        headers:{'Authorization':'Bearer '+SOV_KEY}
      });
      const d = await r.json();
      await addLine('â”€â”€ NODE STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
      await addLine('  Node:    '+d.node,'success');
      await addLine('  Host:    '+d.host,'info');
      await addLine('  Model:   '+d.model,'info');
      await addLine('  Disk:    '+d.disk_free_gb+' GB free','info');
      await addLine('  Sovereign: '+d.sovereign,'success');
      await addLine('  Operator: '+d.operator,'success');
      await addLine('  Models:','info');
      (d.models_available||[]).forEach(m=>addLine('    â—† '+m,'info'));
      await addLine('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    }catch(e){await addLine('âœ— '+e.message,'error')}
    return;
  }

  if(lower==='models'){
    if(!SOV_KEY){await addLine('âœ— No key','error');return}
    try{
      const r=await fetch(BASE+'/v1/models',{headers:{'Authorization':'Bearer '+SOV_KEY}});
      const d=await r.json();
      const list=(d.data||[]).map(m=>m.id);
      if(list.length){ await addLine('â†‘â†“ navigate Â· ENTER to select','info'); openModelSelector(list); }
      else await addLine('No models ready yet â€” they may still be pulling','warning');
    }catch(e){await addLine('âœ— '+e.message,'error')}
    return;
  }

  if(lower.startsWith('model ')){
    if(!SOV_KEY){await addLine('âœ— No key','error');return}
    const name = cmd.slice(6).trim();
    try{
      const r=await fetch(BASE+'/amallo/model',{
        method:'POST',headers:{'Authorization':'Bearer '+SOV_KEY,'Content-Type':'application/json'},
        body:JSON.stringify({model:name})
      });
      const d=await r.json();
      if(d.switched){
        currentModel=d.model;
        document.getElementById('model-label').textContent=d.model.split('-')[0].toUpperCase();
        await addLine('âœ” Switched to: '+d.model,'success');
      }else{
        await addLine('âœ— '+d.model,'error');
      }
    }catch(e){await addLine('âœ— '+e.message,'error')}
    return;
  }

  // â”€â”€ BRAIN â”€â”€
  if(lower==='brain'||lower.startsWith('brain ')){
    const q=cmd.slice(5).trim()||'What are you?';
    await addLine('routing via amallo-brain...','info');
    try{
      const r=await fetch(BRAIN_URL+'/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'brain',messages:[{role:'user',content:q}]})});
      const d=await r.json();
      const rt=d.routing||{};
      await addLine('  intent:'+rt.intent+' backend:'+rt.backend+' model:'+rt.model,'info');
      await streamResponse(d.choices[0].message.content);
    }catch(e){await addLine('brain offline â€” run: amallo-brain','error')}
    return;
  }

  // â”€â”€ DIFFUSION â”€â”€
  if(lower==='diffusion'||lower.startsWith('diffusion ')){
    const q=cmd.slice(9).trim()||'Hello';
    await addLine('sending to LLaDA diffusion engine...','info');
    await addLine('  masked diffusion: generates all tokens in parallel','info');
    try{
      const r=await fetch(DIFF_URL+'/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'GSAI-ML/LLaDA-8B-Instruct',messages:[{role:'user',content:q}]})});
      const d=await r.json();
      const u=d.usage||{};
      if(u.diffusion_steps)await addLine('  steps:'+u.diffusion_steps+' | '+u.tokens_per_sec+'tok/s','info');
      await streamResponse(d.choices[0].message.content);
    }catch(e){await addLine('diffusion offline â€” run: amallo-diffusion','error')}
    return;
  }

  // â”€â”€ PARADIGM â”€â”€
  if(lower==='paradigm'){
    await addLine('â”€â”€ INFERENCE PARADIGMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    await addLine('  AUTOREGRESSIVE  llama.cpp / GGUF','info');
    await addLine('  one token at a time  latency=O(tokens)','warning');
    await addLine('  good for: reasoning chains, streaming, long text','info');
    await addLine('','info');
    await addLine('  MASKED DIFFUSION  LLaDA / amallo-diffusion','info');
    await addLine('  [MASK][MASK]... denoised in parallel over N steps','info');
    await addLine('  latency=O(steps)  GPU parallelism wins here','success');
    await addLine('  best for: FIM, code editing, short rewrites','info');
    await addLine('','info');
    await addLine('  BRAIN ROUTER  amallo-brain :8100','info');
    await addLine('  0ms regex classify  routes to optimal specialist','info');
    await addLine('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    return;
  }

  // â”€â”€ STACK â”€â”€
  if(lower==='stack'){
    await addLine('â”€â”€ SOVEREIGN STACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    const checks=[[BASE+'/health','gguf  :443'],[BRAIN_URL+'/health','brain :8100'],[DIFF_URL+'/health','diff  :8200']];
    for(const [url,lbl] of checks){
      try{const r=await fetch(url);const d=await r.json();await addLine('  âœ” '+lbl+'  '+(d.model||d.node||'ok'),'success');}
      catch(e){await addLine('  âœ— '+lbl+'  offline','error');}
    }
    await addLine('  github: github.com/Kelushael/sovereign-stack','info');
    await addLine('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    return;
  }

  // â”€â”€ INSTALL â”€â”€
  if(lower==='install'){
    await addLine('â”€â”€ INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    await addLine('  bash <(curl -s https://axismundi.fun/install.sh)','system');
    await addLine('  git clone https://github.com/Kelushael/sovereign-stack','system');
    await addLine('  cd sovereign-stack && bash install.sh','system');
    await addLine('  installs: axis copilot keybinds brain quant diffusion','info');
    await addLine('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€','system');
    return;
  }

  // â”€â”€ /addcmd â”€â”€
  if(lower.startsWith('/addcmd')){
    const rest = cmd.slice(7).trim();
    if(!rest){await addLine('Usage: /addcmd describe what it does  OR  /addcmd myname: description','warning');return;}
    let name, action;
    // support explicit name: "/addcmd myname: does this thing"
    const colon = rest.indexOf(':');
    if(colon>0 && colon<24 && !rest.slice(0,colon).includes(' ')){
      name   = rest.slice(0,colon).trim().toLowerCase();
      action = rest.slice(colon+1).trim();
    } else {
      action = rest;
      name   = autoNameCmd(rest);
    }
    customCmds[name]={action,created:Date.now()};
    saveCustomCmds();
    await addLine('âœ” /'+name+' â†’ "'+action+'"','success');
    await addLine('  Saved. Type /'+name+' to run it.','info');
    await addLine('  Rename: /addcmd newname: '+action,'info');
    return;
  }

  // â”€â”€ custom commands â”€â”€
  const customKey = lower.startsWith('/') ? lower.slice(1).split(' ')[0] : null;
  if(customKey && customCmds[customKey]){
    const action = customCmds[customKey].action;
    await addLine('â–¶ '+action,'info');
    // treat action as a new command
    await handleCmd(action + ' ' + cmd.slice(customKey.length+1).trim());
    return;
  }

  // â”€â”€ save / download â”€â”€
  if(lower.startsWith('save') || lower.startsWith('download')){
    const fname = cmd.split(' ')[1] || 'amallo-output';
    if(!lastAIText){await addLine('âœ— No AI response to save yet','error');return;}
    addDownloadLine(lastAIText, fname);
    await addLine('âœ” Click the link above to download','success');
    return;
  }

  // â”€â”€ INFERENCE â”€â”€
  if(!SOV_KEY){
    await addLine('âœ— No SOV key. Run: getkey yourname','error');
    return;
  }

  const pingStart = Date.now();
  const thinkLine = document.createElement('div');
  thinkLine.className='line info';
  thinkLine.textContent='â—ˆ thinking';
  out.appendChild(thinkLine);
  const thinking = setInterval(()=>{
    const dots='.'.repeat((Date.now()/300|0)%4);
    thinkLine.textContent='â—ˆ thinking'+dots;
    out.scrollTop=out.scrollHeight;
  },100);

  try{
    const r=await fetch(BASE+'/v1/chat/completions',{
      method:'POST',
      headers:{'Authorization':'Bearer '+SOV_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'current',
        messages:[{role:'user',content:cmd}],
        max_tokens:1024
      })
    });
    const d=await r.json();
    clearInterval(thinking);
    thinkLine.remove();
    const ms = Date.now()-pingStart;
    const reply = d.choices?.[0]?.message?.content || d.error || JSON.stringify(d);
    lastAIText = reply;
    await typeWriter(reply,'ai');
    onAIResponse(reply);
    // auto download button if response looks like a script
    if(reply.includes('#!/') || (reply.includes('\n') && (reply.includes('def ') || reply.includes('function ') || reply.includes('apt') || reply.includes('pip ')))){
      addDownloadLine(reply, 'amallo-script');
    }
    await addLine('  ['+d.model+' Â· '+ms+'ms Â· type "save [name]" to download]','info');
  }catch(e){
    clearInterval(thinking);
    thinkLine.remove();
    await addLine('âœ— '+e.message,'error');
  }
}

// â”€â”€ INPUT HANDLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const input = document.getElementById('cmd-input');
const inputArea = document.getElementById('input-area');

input.addEventListener('input',()=>{
  const v = input.value;
  if(v) inputArea.classList.add('typing');
  else inputArea.classList.remove('typing');
  // open palette when first char typed is /
  if(v === '/'){
    openPalette('');
  } else if(v.startsWith('/') && paletteOpen){
    paletteIdx = 0;
    renderPalette(v.slice(1));
  } else if(!v.startsWith('/') && paletteOpen){
    closePalette();
  }
});

input.addEventListener('keydown',async e=>{
  if(e.key==='Enter'){
    const v=input.value.trim();
    if(!v) return;
    // close palette if open â€” Enter on empty-after-palette means cancel
    if(paletteOpen){ closePalette(); if(!v||v==='/') return; }
    cmdHistory.unshift(v);
    if(cmdHistory.length>100) cmdHistory.pop();
    localStorage.setItem('amallo_history',JSON.stringify(cmdHistory));
    histIdx=-1;
    input.value='';
    inputArea.classList.remove('typing');
    await handleCmd(v);
  } else if(e.key==='ArrowUp'){
    e.preventDefault();
    if(histIdx<cmdHistory.length-1){
      histIdx++;
      input.value=cmdHistory[histIdx];
    }
  } else if(e.key==='ArrowDown'){
    e.preventDefault();
    if(histIdx>0){histIdx--;input.value=cmdHistory[histIdx];}
    else{histIdx=-1;input.value='';}
  } else if(e.key==='Tab'){
    e.preventDefault();
    // Tab still works for non-/ completions
    if(!input.value.startsWith('/')){
      const cmds=['help','clear','getkey ','setkey ','status','models','model ','save ','download '];
      const match=cmds.find(c=>c.startsWith(input.value));
      if(match) input.value=match;
    }
  }
});

document.addEventListener('keydown',e=>{
  // Ctrl+Shift+C = toggle auto-chain
  if(e.ctrlKey && e.shiftKey && e.key==='C'){
    e.preventDefault();
    toggleChain();
    return;
  }
  if(document.activeElement!==input && !e.ctrlKey && !e.metaKey && e.key.length===1){
    input.focus();
  }
});

// â”€â”€ DOWNLOAD HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastAIText = '';

// â”€â”€ AUTO-CHAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Toggle: on each AI response, copy it into input and submit.
// Ctrl+Shift+C to toggle. Chain button in input bar for visual state.
let autoChain = false;
let chainCooldown = false; // prevent re-entrancy

function toggleChain(){
  autoChain = !autoChain;
  const btn = document.getElementById('chain-btn');
  btn.classList.toggle('active', autoChain);
  btn.title = autoChain
    ? 'Auto-chain ON â€” each AI response feeds back as next prompt (Ctrl+Shift+C to toggle)'
    : 'Auto-chain OFF (Ctrl+Shift+C to toggle)';
  addLine(autoChain
    ? 'â›“ CHAIN ON  1) double-Enter (clears y/n)  2) extract code  3) paste+run. Ctrl+Shift+C to stop.'
    : 'â›“ CHAIN OFF', autoChain ? 'warning' : 'info');
}

function onAIResponse(text){
  if(!autoChain || chainCooldown || !text) return;
  chainCooldown = true;

  // STEP 1: double-tap Enter immediately â€” clears any y/n / "press enter" gate
  // before we try to paste code. Fires blind, no harm if nothing is waiting.
  fireSubmit('y');
  setTimeout(()=> fireSubmit('y'), 180);

  // STEP 2: extract just the code from the response (strip markdown fences etc.)
  // then paste + Enter as if user typed it
  const delay = Math.max(900, Math.min(text.length * 8, 3000));
  setTimeout(()=>{
    chainCooldown = false;
    if(!autoChain) return;
    fireSubmit(extractCode(text).slice(0, 2000));
  }, delay);
}

// pull the first code block out of a response, or fall back to full text
function extractCode(text){
  // match ```lang\n...code...\n``` â€” grab just the inner content
  const fenced = text.match(/```(?:\w+)?\n?([\s\S]*?)```/);
  if(fenced) return fenced[1].trim();
  // match single-backtick inline code if that's all there is
  const inline = text.match(/`([^`]+)`/);
  if(inline && text.replace(/`[^`]+`/g,'').trim().length < 20) return inline[1].trim();
  // no code block â€” return full text (it's a plain response, let it through)
  return text.trim();
}

// fire a value into handleCmd as if user typed + hit Enter
function fireSubmit(val){
  const v = val.trim();
  if(!v) return;
  cmdHistory.unshift(v);
  localStorage.setItem('amallo_history', JSON.stringify(cmdHistory));
  histIdx = -1;
  input.value = '';
  inputArea.classList.remove('typing');
  handleCmd(v);
}
function makeDownloadLink(text, suggestedName){
  const ext = text.trim().startsWith('#!/') ? text.split('\n')[0].includes('python') ? '.py' : '.sh'
              : text.includes('def ') || text.includes('import ') ? '.py'
              : text.includes('function ') || text.includes('const ') ? '.js'
              : '.txt';
  const fname = (suggestedName || 'amallo-script') + ext;
  const blob = new Blob([text], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = fname;
  a.className = 'dl-btn';
  a.innerHTML = 'â¬‡ ' + fname;
  a.addEventListener('click',()=>setTimeout(()=>URL.revokeObjectURL(url),2000));
  return a;
}

function addDownloadLine(text, name){
  const wrapper = document.createElement('div');
  wrapper.style.paddingLeft='16px';
  wrapper.appendChild(makeDownloadLink(text, name));
  out.appendChild(wrapper);
  out.scrollTop = out.scrollHeight;
}

// â”€â”€ MODEL SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectorOpen = false;
let selectorModels = [];
let selectorIdx = 0;

function openModelSelector(modelList){
  selectorModels = modelList;
  selectorIdx = 0;
  const sel = document.getElementById('model-selector');
  sel.innerHTML = `<div class="model-selector-header">
    <span>SELECT MODEL</span>
    <span style="color:rgba(255,255,255,0.3)">â†‘â†“ navigate Â· ENTER select Â· ESC close</span>
  </div>`;
  modelList.forEach((m,i)=>{
    const item = document.createElement('div');
    item.className = 'model-item' + (i===0?' focused':'');
    item.dataset.idx = i;
    item.innerHTML = `<div class="check">${m===currentModel?'âœ“':''}</div><span>${m}</span>`;
    item.addEventListener('click',()=>{ selectModel(m); closeSelector(); });
    sel.appendChild(item);
  });
  sel.classList.add('open');
  selectorOpen = true;
  document.addEventListener('keydown', selectorKeyHandler);
}

function closeSelector(){
  document.getElementById('model-selector').classList.remove('open');
  selectorOpen = false;
  document.removeEventListener('keydown', selectorKeyHandler);
  input.focus();
}

function selectorKeyHandler(e){
  if(!selectorOpen) return;
  const items = document.querySelectorAll('.model-item');
  if(e.key==='ArrowDown'){e.preventDefault();selectorIdx=Math.min(selectorIdx+1,selectorModels.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();selectorIdx=Math.max(selectorIdx-1,0);}
  else if(e.key==='Enter'){e.preventDefault();selectModel(selectorModels[selectorIdx]);closeSelector();return;}
  else if(e.key==='Escape'){closeSelector();return;}
  items.forEach((it,i)=>it.classList.toggle('focused',i===selectorIdx));
  items[selectorIdx]?.scrollIntoView({block:'nearest'});
}

async function selectModel(name){
  if(!SOV_KEY){await addLine('âœ— No key','error');return;}
  try{
    const r=await fetch(BASE+'/amallo/model',{
      method:'POST',headers:{'Authorization':'Bearer '+SOV_KEY,'Content-Type':'application/json'},
      body:JSON.stringify({model:name})
    });
    const d=await r.json();
    currentModel=d.model;
    document.getElementById('model-label').textContent=d.model.split(':')[0].split('-')[0].toUpperCase().slice(0,8);
    await addLine('âœ” Model: '+d.model,'success');
  }catch(e){await addLine('âœ— '+e.message,'error')}
}

// â”€â”€ CUSTOM COMMANDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let customCmds = JSON.parse(localStorage.getItem('amallo_cmds')||'{}');

function saveCustomCmds(){
  localStorage.setItem('amallo_cmds',JSON.stringify(customCmds));
}

// â”€â”€ TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUtterance = null;
function speakText(text, btn){
  if(!window.speechSynthesis) return;
  // stop any current speech
  if(currentUtterance){
    window.speechSynthesis.cancel();
    document.querySelectorAll('.play-btn.speaking').forEach(b=>b.classList.remove('speaking'));
    if(currentUtterance._btn === btn){
      currentUtterance = null;
      return; // toggle off
    }
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter._btn = btn;
  utter.rate = 1.05;
  utter.pitch = 0.9;
  // pick a slightly deeper voice if available
  const voices = window.speechSynthesis.getVoices();
  const preferred = voices.find(v=>v.name.includes('Google UK English Male'))
    || voices.find(v=>v.name.toLowerCase().includes('male'))
    || voices[0];
  if(preferred) utter.voice = preferred;
  utter.onstart = ()=>{ btn.textContent='â¹'; btn.classList.add('speaking'); };
  utter.onend = ()=>{ btn.textContent='â–¶'; btn.classList.remove('speaking'); currentUtterance=null; };
  utter.onerror = ()=>{ btn.textContent='â–¶'; btn.classList.remove('speaking'); currentUtterance=null; };
  currentUtterance = utter;
  window.speechSynthesis.speak(utter);
}

// â”€â”€ STT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const micBtn = document.getElementById('mic-btn');
let recognition = null;
let isListening = false;

function initSTT(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    micBtn.title = 'Speech recognition not supported in this browser';
    micBtn.style.opacity = '0.3';
    micBtn.style.cursor = 'not-allowed';
    return;
  }
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  recognition.onstart = ()=>{
    isListening = true;
    micBtn.classList.add('listening');
    micBtn.textContent = 'ğŸ”´';
    input.placeholder = 'listening...';
  };

  recognition.onresult = (e)=>{
    let interim = '';
    let final = '';
    for(let i=e.resultIndex;i<e.results.length;i++){
      if(e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    input.value = (final || interim).trim();
    inputArea.classList.add('typing');
  };

  recognition.onend = ()=>{
    isListening = false;
    micBtn.classList.remove('listening');
    micBtn.textContent = 'ğŸ™';
    input.placeholder = 'awaiting sovereign command...';
    // auto-submit if we got something
    const v = input.value.trim();
    if(v){
      cmdHistory.unshift(v);
      if(cmdHistory.length>100) cmdHistory.pop();
      localStorage.setItem('amallo_history',JSON.stringify(cmdHistory));
      histIdx=-1;
      input.value='';
      inputArea.classList.remove('typing');
      handleCmd(v);
    }
  };

  recognition.onerror = (e)=>{
    isListening = false;
    micBtn.classList.remove('listening');
    micBtn.textContent = 'ğŸ™';
    input.placeholder = 'awaiting sovereign command...';
    if(e.error !== 'no-speech'){
      addLine('âœ— mic: '+e.error,'error');
    }
  };
}

micBtn.addEventListener('click',()=>{
  if(!recognition) initSTT();
  if(!recognition) return;
  if(isListening){
    recognition.stop();
  } else {
    try{ recognition.start(); }
    catch(e){ addLine('âœ— mic: '+e.message,'error'); }
  }
});

// lazy-init STT on first interaction
initSTT();

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
boot();
</script>
</body>
</html>
