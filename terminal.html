<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMALLO ‚Äî Sovereign Terminal</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--orange:#FF6B00;--blue:#89CFF0;--purple:#C084FC;--lime:#BEFF00;--dark:#08030A;--dim:#1A0A00;}
html,body{height:100%;overflow:hidden;background:var(--dark);font-family:'Courier New',monospace;}

#matrix-canvas{position:fixed;inset:0;z-index:0;opacity:0.07;pointer-events:none;}
#particle-canvas{position:fixed;inset:0;z-index:1;pointer-events:none;}
.scanlines{position:fixed;inset:0;z-index:100;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px);}
.vignette{position:fixed;inset:0;z-index:99;pointer-events:none;background:radial-gradient(ellipse at center,transparent 50%,rgba(0,0,0,0.7) 100%);}

#app{position:relative;z-index:10;display:flex;flex-direction:column;height:100vh;border:1px solid rgba(137,207,240,0.15);box-shadow:0 0 80px rgba(255,107,0,0.08),0 0 40px rgba(192,132,252,0.05),inset 0 0 80px rgba(0,0,0,0.5);animation:frame-breathe 4s ease-in-out infinite;}
@keyframes frame-breathe{0%,100%{box-shadow:0 0 60px rgba(255,107,0,0.06),0 0 30px rgba(192,132,252,0.04),inset 0 0 80px rgba(0,0,0,0.5)}50%{box-shadow:0 0 100px rgba(255,107,0,0.12),0 0 60px rgba(192,132,252,0.08),inset 0 0 80px rgba(0,0,0,0.5)}}

#header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid rgba(137,207,240,0.1);background:rgba(8,3,10,0.9);backdrop-filter:blur(20px);position:relative;overflow:hidden;}
#header::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,107,0,0.05) 0%,transparent 30%,transparent 70%,rgba(192,132,252,0.05) 100%);animation:header-sweep 8s ease-in-out infinite alternate;}
@keyframes header-sweep{0%{opacity:0.5;transform:translateX(-10%)}100%{opacity:1;transform:translateX(10%)}}

.logo-text{font-size:18px;font-weight:900;letter-spacing:8px;position:relative;z-index:1;animation:glitch 6s ease-in-out infinite;}
.logo-text .l1{color:var(--blue)}.logo-text .l2{color:var(--purple)}.logo-text .l3{color:var(--orange)}.logo-text .l4{color:var(--blue)}.logo-text .l5{color:var(--lime)}.logo-text .l6{color:var(--purple)}
@keyframes glitch{0%,90%,100%{text-shadow:none;transform:none}92%{text-shadow:2px 0 var(--orange),-2px 0 var(--blue);transform:skewX(-1deg)}94%{text-shadow:-3px 0 var(--purple),3px 0 var(--lime);transform:skewX(1deg)}96%{text-shadow:1px 0 var(--blue),-1px 0 var(--orange);transform:none}98%{text-shadow:none;transform:skewX(-0.5deg)}}

.status-pills{display:flex;gap:16px;align-items:center;font-size:10px;letter-spacing:2px;position:relative;z-index:1;}
.pill{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,0.4);}
.pill .dot{width:6px;height:6px;border-radius:50%;animation:pill-pulse 2s ease-in-out infinite;}
.pill.online .dot{background:var(--lime);box-shadow:0 0 8px var(--lime)}
.pill.model .dot{background:var(--purple);box-shadow:0 0 8px var(--purple)}
.pill.ssh-mode .dot{background:var(--blue);box-shadow:0 0 8px var(--blue)}
@keyframes pill-pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.7)}}

#content-area{flex:1;display:flex;overflow:hidden;}
#output{flex:1;overflow-y:auto;padding:20px;scroll-behavior:smooth;}
#output::-webkit-scrollbar{width:4px}
#output::-webkit-scrollbar-track{background:transparent}
#output::-webkit-scrollbar-thumb{background:rgba(137,207,240,0.2);border-radius:2px}

/* OMNI SPLIT PANEL */
#omni-panel{display:none;width:0;border-left:1px solid rgba(255,107,0,0.25);background:rgba(255,60,0,0.03);flex-direction:column;transition:width 0.35s ease;}
#omni-panel.active{display:flex;width:260px;}
.omni-hdr{padding:10px 14px 8px;font-size:9px;letter-spacing:3px;color:var(--orange);border-bottom:1px solid rgba(255,107,0,0.15);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
.omni-hdr span:first-child{animation:omni-pulse 2s ease-in-out infinite;}
@keyframes omni-pulse{0%,100%{opacity:0.7}50%{opacity:1;text-shadow:0 0 10px rgba(255,107,0,0.6)}}
#omni-close{cursor:pointer;color:rgba(255,255,255,0.3);font-size:14px;}
#omni-close:hover{color:var(--orange);}
.omni-from{padding:8px 14px 4px;font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.3);}
#omni-text{flex:1;padding:8px 14px;font-size:13px;line-height:1.7;color:rgba(255,255,255,0.8);overflow-y:auto;white-space:pre-wrap;}

.line{margin-bottom:4px;line-height:1.6;font-size:13px;animation:line-in 0.15s ease forwards;opacity:0;transform:translateX(-4px);}
@keyframes line-in{to{opacity:1;transform:translateX(0)}}
.line.system{color:rgba(137,207,240,0.6)}.line.user{color:var(--blue);font-weight:bold}
.line.success{color:var(--lime);text-shadow:0 0 8px rgba(190,255,0,0.3)}.line.error{color:#FF4444}
.line.warning{color:var(--orange)}.line.info{color:rgba(255,255,255,0.45)}
.line.ai{color:rgba(255,255,255,0.85);border-left:2px solid var(--purple);padding-left:12px;margin-left:4px;}
.line.sep{color:rgba(137,207,240,0.2);}

.typing-cursor{display:inline-block;width:8px;height:14px;background:var(--purple);animation:blink 0.7s step-end infinite;vertical-align:middle;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

.ascii-banner{color:rgba(255,107,0,0.35);font-size:9px;line-height:1.2;margin-bottom:12px;white-space:pre;animation:ascii-breathe 6s ease-in-out infinite;}
@keyframes ascii-breathe{0%,100%{color:rgba(255,107,0,0.25);text-shadow:none}50%{color:rgba(255,107,0,0.5);text-shadow:0 0 20px rgba(255,107,0,0.3)}}

/* CONNECT CARD */
#connect-card{margin:0 20px 8px;padding:12px 16px;border:1px solid rgba(137,207,240,0.15);border-radius:4px;background:rgba(137,207,240,0.03);display:none;}
#connect-card.visible{display:block;}
.cc-title{font-size:9px;letter-spacing:3px;color:rgba(137,207,240,0.5);margin-bottom:8px;}
.cc-row{display:flex;gap:12px;margin-bottom:4px;font-size:12px;align-items:baseline;}
.cc-cmd{color:var(--lime);cursor:pointer;letter-spacing:1px;}
.cc-cmd:hover{text-shadow:0 0 8px var(--lime);}
.cc-desc{color:rgba(255,255,255,0.25);font-size:11px;}

/* ‚îÄ‚îÄ SLASH COMMAND MENU ‚îÄ‚îÄ */
#slash-menu{
  display:none;position:absolute;bottom:56px;left:0;right:0;
  background:rgba(6,2,9,0.97);
  border-top:2px solid var(--blue);
  border-bottom:none;
  z-index:400;
  max-height:340px;overflow-y:auto;
  box-shadow:0 -20px 60px rgba(0,0,0,0.8),0 -4px 20px rgba(137,207,240,0.08);
  backdrop-filter:blur(20px);
}
#slash-menu.open{display:block;}
#slash-menu::-webkit-scrollbar{width:3px}
#slash-menu::-webkit-scrollbar-thumb{background:rgba(137,207,240,0.2)}

.sm-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:7px 16px 5px;
  font-size:9px;letter-spacing:3px;
  color:rgba(255,255,255,0.2);
  border-bottom:1px solid rgba(255,255,255,0.04);
}
.sm-header .sm-hint{font-size:9px;letter-spacing:1px;color:rgba(255,255,255,0.12);}

.sm-item{
  display:flex;align-items:center;gap:0;
  padding:8px 16px;
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,0.03);
  transition:background 0.08s;
  position:relative;
}
.sm-item:hover,.sm-item.focused{
  background:rgba(137,207,240,0.05);
}
.sm-item.focused::before{
  content:'';position:absolute;left:0;top:0;bottom:0;width:2px;
  background:var(--blue);
}
.sm-item.focused .sm-name{color:rgba(255,255,255,0.95);}

.sm-name{
  font-size:13px;color:rgba(137,207,240,0.8);
  letter-spacing:0.5px;min-width:180px;
  display:flex;align-items:baseline;gap:8px;
}
.sm-name .sm-cmd{color:var(--blue);font-weight:bold;}
.sm-name .sm-arg{color:rgba(255,255,255,0.25);font-size:11px;font-weight:normal;}
.sm-desc{font-size:12px;color:rgba(255,255,255,0.28);flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sm-badge{font-size:9px;letter-spacing:1px;color:var(--lime);opacity:0.5;margin-left:auto;padding-left:12px;flex-shrink:0;}

/* MIC */
#mic-btn{background:none;border:none;cursor:pointer;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:rgba(137,207,240,0.5);border:1px solid rgba(137,207,240,0.15);transition:all 0.2s;flex-shrink:0;font-size:16px;}
#mic-btn:hover{color:var(--blue);border-color:rgba(137,207,240,0.4);box-shadow:0 0 12px rgba(137,207,240,0.2)}
#mic-btn.listening{color:#FF4444;border-color:rgba(255,68,68,0.6);box-shadow:0 0 16px rgba(255,68,68,0.4);animation:mic-pulse 0.8s ease-in-out infinite;}
@keyframes mic-pulse{0%,100%{box-shadow:0 0 10px rgba(255,68,68,0.3)}50%{box-shadow:0 0 25px rgba(255,68,68,0.7),0 0 50px rgba(255,68,68,0.3)}}

.dl-btn{display:inline-flex;align-items:center;gap:5px;margin:6px 0 2px 16px;padding:4px 10px;background:rgba(190,255,0,0.08);border:1px solid rgba(190,255,0,0.3);border-radius:4px;color:var(--lime);font-size:11px;letter-spacing:1px;cursor:pointer;text-decoration:none;font-family:'Courier New',monospace;transition:all 0.2s;}
.dl-btn:hover{background:rgba(190,255,0,0.18);box-shadow:0 0 12px rgba(190,255,0,0.3)}

.play-btn{display:inline-flex;align-items:center;justify-content:center;margin-left:8px;cursor:pointer;width:18px;height:18px;border-radius:50%;background:rgba(192,132,252,0.15);border:1px solid rgba(192,132,252,0.3);color:var(--purple);font-size:8px;transition:all 0.2s;vertical-align:middle;flex-shrink:0;}
.play-btn:hover{background:rgba(192,132,252,0.3);box-shadow:0 0 10px rgba(192,132,252,0.4)}
.play-btn.speaking{background:rgba(192,132,252,0.3);box-shadow:0 0 12px rgba(192,132,252,0.5);}

/* INPUT AREA */
#input-area{padding:10px 20px;border-top:1px solid rgba(137,207,240,0.08);background:rgba(8,3,10,0.95);display:flex;align-items:center;gap:10px;position:relative;}
#input-area::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--orange),var(--purple),var(--lime),transparent);opacity:0.3;animation:input-line 4s linear infinite;background-size:200% 100%;}
@keyframes input-line{0%{background-position:200% 0}100%{background-position:-200% 0}}

.prompt-symbol{color:var(--lime);font-size:16px;font-weight:bold;text-shadow:0 0 10px var(--lime);animation:prompt-pulse 2s ease-in-out infinite;transition:color 0.2s;}
@keyframes prompt-pulse{0%,100%{text-shadow:0 0 8px var(--lime)}50%{text-shadow:0 0 20px var(--lime),0 0 40px rgba(190,255,0,0.3)}}
.prompt-symbol.ssh-mode{color:var(--blue);text-shadow:0 0 10px var(--blue);}
.prompt-symbol.pw-mode{color:var(--orange);text-shadow:0 0 10px var(--orange);}

#cmd-input{flex:1;background:transparent;border:none;outline:none;color:var(--blue);font-family:'Courier New',monospace;font-size:14px;caret-color:var(--lime);text-shadow:0 0 8px rgba(137,207,240,0.4);}
#cmd-input::placeholder{color:rgba(255,255,255,0.1);font-style:italic;font-size:12px;}
#input-area.typing{background:rgba(12,5,18,0.98);}
#input-area.pw-mode #cmd-input{color:var(--orange);}

/* MODEL SELECTOR */
#model-selector{display:none;position:absolute;bottom:56px;left:20px;right:20px;background:rgba(8,3,10,0.97);border:1px solid rgba(192,132,252,0.4);border-radius:6px;box-shadow:0 0 40px rgba(192,132,252,0.2);max-height:280px;overflow-y:auto;z-index:200;}
#model-selector.open{display:block}
.model-selector-header{padding:8px 14px;font-size:10px;letter-spacing:2px;color:var(--purple);border-bottom:1px solid rgba(192,132,252,0.2);display:flex;justify-content:space-between;}
.model-item{display:flex;align-items:center;gap:12px;padding:8px 14px;cursor:pointer;font-size:13px;color:rgba(255,255,255,0.6);border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.1s;}
.model-item:hover,.model-item.focused{background:rgba(192,132,252,0.1);color:rgba(255,255,255,0.9);}
.model-item.focused{border-left:2px solid var(--purple)}
.model-item .check{width:14px;height:14px;border-radius:2px;border:1px solid rgba(192,132,252,0.4);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;}
.model-item.selected .check{background:var(--purple);border-color:var(--purple);color:#000;}

#node-bar{display:flex;justify-content:space-between;padding:3px 20px;font-size:9px;letter-spacing:2px;color:rgba(255,255,255,0.1);border-top:1px solid rgba(255,255,255,0.03);background:rgba(0,0,0,0.4);}

/* SPAM PILL */
#spam-indicator{display:none;color:var(--orange);animation:pill-pulse 0.4s ease-in-out infinite}
</style>
</head>
<body>
<canvas id="matrix-canvas"></canvas>
<canvas id="particle-canvas"></canvas>
<div class="scanlines"></div>
<div class="vignette"></div>

<div id="app">
  <div id="header">
    <div class="logo-text">
      <span class="l1">A</span><span class="l2">M</span><span class="l3">A</span><span class="l4">L</span><span class="l5">L</span><span class="l6">O</span>
      <span style="color:rgba(255,255,255,0.2);font-size:11px;letter-spacing:4px;margin-left:12px">SOVEREIGN SHELL</span>
    </div>
    <div class="status-pills">
      <div class="pill online"><div class="dot"></div><span id="node-label">NODE ZERO</span></div>
      <div class="pill model"><div class="dot"></div><span id="model-label">DOLPHIN</span></div>
      <div id="ssh-pill" class="pill ssh-mode" style="display:none"><div class="dot"></div><span id="ssh-label">YOUR NODE</span></div>
      <div id="spam-indicator" class="pill">
        <div class="dot" style="background:var(--orange);box-shadow:0 0 8px var(--orange)"></div>
        <span>‚ö° SPAM</span>
      </div>
    </div>
  </div>

  <div id="content-area">
    <div id="output"></div>
    <div id="omni-panel">
      <div class="omni-hdr">
        <span>‚¨° AXIS OMNI</span>
        <span id="omni-close">‚úï</span>
      </div>
      <div class="omni-from" id="omni-meta"></div>
      <div id="omni-text"></div>
    </div>
  </div>

  <div id="connect-card" class="visible">
    <div class="cc-title">CHOOSE YOUR NODE</div>
    <div class="cc-row">
      <span class="cc-cmd" onclick="fillCmd('connect ')">connect user@192.168.x.x</span>
      <span class="cc-desc">inference runs on YOUR machine</span>
    </div>
    <div class="cc-row">
      <span class="cc-cmd" onclick="fillCmd('demo')">demo</span>
      <span class="cc-desc">use shared node (no setup needed)</span>
    </div>
  </div>

  <div id="model-selector"></div>

  <!-- SLASH COMMAND MENU ‚Äî lives inside #input-area positioning context -->
  <div id="slash-menu"></div>

  <div id="input-area">
    <span class="prompt-symbol" id="prompt-sym">‚ùØ</span>
    <input id="cmd-input" type="text" placeholder="type / for commands, or connect user@host" autocomplete="off" spellcheck="false" autofocus />
    <button id="mic-btn" title="Voice input">üéô</button>
  </div>

  <div id="node-bar">
    <span id="nb-host">axismundi.fun ¬∑ amallo-controller</span>
    <span>latency: <span id="ms">‚Äî</span>ms</span>
    <span>sovereign ¬∑ unbolted</span>
  </div>
</div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE='https://axismundi.fun';
let SOV_KEY=localStorage.getItem('amallo_key')||'';
let sshSession=null;
let demoMode=false;
let cmdHistory=JSON.parse(localStorage.getItem('amallo_history')||'[]');
let histIdx=-1;
let currentModel='dolphin-mistral';
let lastAIText='';
let pwMode=false,pwCallback=null;

// ‚îÄ‚îÄ SLASH COMMANDS REGISTRY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BUILTIN_CMDS=[
  {cmd:'connect',arg:'user@host[:port]',desc:'SSH into your machine ‚Äî inference runs there'},
  {cmd:'demo',arg:'',desc:'Use shared demo node (no setup needed)'},
  {cmd:'disconnect',arg:'',desc:'Return to connect screen'},
  {cmd:'help',arg:'',desc:'Show all commands'},
  {cmd:'clear',arg:'',desc:'Wipe screen'},
  {cmd:'status',arg:'',desc:'Node health, RAM, disk, active sessions'},
  {cmd:'models',arg:'',desc:'List and select model  ‚Üë‚Üì Enter'},
  {cmd:'model',arg:'[name]',desc:'Switch model directly'},
  {cmd:'exec',arg:'[shell cmd]',desc:'Run command on connected machine'},
  {cmd:'save',arg:'[filename]',desc:'Download last AI response as file'},
  {cmd:'omni',arg:'[message]',desc:'Broadcast to all terminals (needs admin pw)'},
  {cmd:'omni clear',arg:'',desc:'Clear broadcast from all terminals'},
  {cmd:'/addcmd',arg:'[name] [action]',desc:'Create a custom shortcut command'},
];

function getAllCmds(){
  const custom=Object.entries(customCmds).map(([k,v])=>({
    cmd:'/'+k,arg:'',desc:v.action+' (custom)',badge:'CUSTOM'
  }));
  return [...BUILTIN_CMDS,...custom];
}

// ‚îÄ‚îÄ MATRIX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const mCvs=document.getElementById('matrix-canvas'),mCtx=mCvs.getContext('2d');
let cols,drops;
function initMatrix(){mCvs.width=window.innerWidth;mCvs.height=window.innerHeight;cols=Math.floor(mCvs.width/16);drops=Array(cols).fill(1);}
function drawMatrix(){
  mCtx.fillStyle='rgba(8,3,10,0.05)';mCtx.fillRect(0,0,mCvs.width,mCvs.height);
  const chars='„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥0123456789AMALLO‚àû‚¨°‚¨¢';
  drops.forEach((y,i)=>{
    const ch=chars[Math.floor(Math.random()*chars.length)],r=Math.random();
    if(r<0.33)mCtx.fillStyle='rgba(255,107,0,0.8)';
    else if(r<0.66)mCtx.fillStyle='rgba(192,132,252,0.8)';
    else mCtx.fillStyle='rgba(190,255,0,0.8)';
    mCtx.font='12px monospace';mCtx.fillText(ch,i*16,y*16);
    if(y*16>mCvs.height&&Math.random()>0.975)drops[i]=0;drops[i]++;
  });
}
initMatrix();setInterval(drawMatrix,60);

const pCvs=document.getElementById('particle-canvas'),pCtx=pCvs.getContext('2d');
const PCOLS=['rgba(255,107,0,','rgba(137,207,240,','rgba(192,132,252,','rgba(190,255,0,'];
let particles=[];
function initParticles(){
  pCvs.width=window.innerWidth;pCvs.height=window.innerHeight;
  particles=Array.from({length:60},()=>({x:Math.random()*pCvs.width,y:Math.random()*pCvs.height,vx:(Math.random()-0.5)*0.4,vy:(Math.random()-0.5)*0.4,r:Math.random()*2+0.5,col:PCOLS[Math.floor(Math.random()*PCOLS.length)],a:Math.random()*0.4+0.1,pulse:Math.random()*Math.PI*2}));
}
function drawParticles(){
  pCtx.clearRect(0,0,pCvs.width,pCvs.height);
  particles.forEach(p=>{p.pulse+=0.02;const a=p.a*(0.6+0.4*Math.sin(p.pulse));pCtx.beginPath();pCtx.arc(p.x,p.y,p.r,0,Math.PI*2);pCtx.fillStyle=p.col+a+')';pCtx.fill();p.x+=p.vx;p.y+=p.vy;if(p.x<0)p.x=pCvs.width;if(p.x>pCvs.width)p.x=0;if(p.y<0)p.y=pCvs.height;if(p.y>pCvs.height)p.y=0;});
}
initParticles();setInterval(drawParticles,30);
window.addEventListener('resize',()=>{initMatrix();initParticles()});

// ‚îÄ‚îÄ LATENCY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function pingLatency(){
  const t=Date.now();
  try{await fetch(BASE+'/health',{cache:'no-store'});document.getElementById('ms').textContent=Date.now()-t;}
  catch{document.getElementById('ms').textContent='?';}
}
pingLatency();setInterval(pingLatency,5000);

// ‚îÄ‚îÄ OUTPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const out=document.getElementById('output');
function addLine(text,type='info',delay=0){
  return new Promise(res=>{setTimeout(()=>{const d=document.createElement('div');d.className='line '+type;d.textContent=text;out.appendChild(d);out.scrollTop=out.scrollHeight;res();},delay);});
}
async function typeWriter(text,type='ai'){
  const d=document.createElement('div');d.className='line '+type;d.style.display='flex';d.style.alignItems='flex-start';d.style.gap='8px';
  const textSpan=document.createElement('span');textSpan.style.flex='1';
  const cursor=document.createElement('span');cursor.className='typing-cursor';
  d.appendChild(textSpan);out.appendChild(d);out.scrollTop=out.scrollHeight;
  for(const ch of text){textSpan.textContent+=ch;textSpan.appendChild(cursor);out.scrollTop=out.scrollHeight;await new Promise(r=>setTimeout(r,Math.random()*18+4));}
  cursor.remove();
  const btn=document.createElement('button');btn.className='play-btn';btn.textContent='‚ñ∂';btn.title='Read aloud';btn.style.marginTop='3px';
  btn.addEventListener('click',()=>speakText(text,btn));d.appendChild(btn);
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function boot(){
  const ascii=`   _   __  __ _   _    _    _     _    ___
  /_\\ |  \\/  /_\\ | |  | |  / \\   /_\\  / _ \\
 //_\\\\| |\\/| //_\\\\| |__| |_/ _ \\ //_\\ \\_, /
/  _  \\_|  |_/  _  \\____\\____/ \\ \\_/  /_/\\__\\`;
  const pre=document.createElement('pre');pre.className='ascii-banner';pre.textContent=ascii;out.appendChild(pre);
  await addLine('AMALLO SOVEREIGN TERMINAL v2.1','system',0);
  await addLine('Inference runs on YOUR machine ‚Äî you bring the compute.','info',80);
  await addLine('','info',160);
  await addLine('  Type  /  to see all commands','info',240);
}

// ‚îÄ‚îÄ FILL CMD HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fillCmd(text){document.getElementById('cmd-input').value=text;document.getElementById('cmd-input').focus();}

// ‚îÄ‚îÄ PASSWORD MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function enterPwMode(prompt,callback){
  pwMode=true;pwCallback=callback;
  const inp=input,sym=document.getElementById('prompt-sym'),area=inputArea;
  inp.type='password';inp.placeholder=prompt;inp.value='';
  sym.className='prompt-symbol pw-mode';area.classList.add('pw-mode');inp.focus();
}
function exitPwMode(){
  pwMode=false;pwCallback=null;
  const inp=input,sym=document.getElementById('prompt-sym'),area=inputArea;
  inp.type='text';
  inp.placeholder=sshSession?'run command on your machine  or  / for menu':'type / for commands, or connect user@host';
  sym.className='prompt-symbol'+(sshSession?' ssh-mode':'');
  area.classList.remove('pw-mode');
}

// ‚îÄ‚îÄ SLASH MENU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let slashOpen=false,slashIdx=0,slashFiltered=[];

function openSlashMenu(filter){
  const q=(filter||'').replace(/^\//,'').toLowerCase();
  const all=getAllCmds();
  slashFiltered=q?all.filter(c=>c.cmd.toLowerCase().includes(q)||(c.desc||'').toLowerCase().includes(q)):all;
  if(!slashFiltered.length){closeSlashMenu();return;}
  slashIdx=0;
  const menu=document.getElementById('slash-menu');
  menu.innerHTML=`<div class="sm-header"><span>COMMANDS</span><span class="sm-hint">‚Üë‚Üì navigate &nbsp;¬∑&nbsp; Enter select &nbsp;¬∑&nbsp; Esc close</span></div>`;
  slashFiltered.forEach((c,i)=>{
    const item=document.createElement('div');
    item.className='sm-item'+(i===0?' focused':'');
    item.dataset.idx=i;
    const isBuiltin=!c.badge;
    item.innerHTML=`<div class="sm-name"><span class="sm-cmd">/${c.cmd}</span>${c.arg?`<span class="sm-arg">${c.arg}</span>`:''}</div><span class="sm-desc">${c.desc||''}</span>${c.badge?`<span class="sm-badge">${c.badge}</span>`:''}`;
    item.addEventListener('mousedown',e=>{e.preventDefault();selectSlashCmd(slashFiltered[i]);});
    menu.appendChild(item);
  });
  menu.classList.add('open');slashOpen=true;
}

function closeSlashMenu(){
  document.getElementById('slash-menu').classList.remove('open');
  slashOpen=false;
}

function selectSlashCmd(c){
  // fill input with command (without leading slash for builtins that don't need it)
  const text = c.cmd.startsWith('/') ? c.cmd+' ' : c.cmd+' ';
  input.value=text.trimEnd().replace(/^\//,'');
  // if has arg, leave cursor at end for user to type arg
  if(c.arg) input.value=text.replace(/^\//,'');
  closeSlashMenu();
  input.focus();
  // place cursor at end
  const len=input.value.length;
  input.setSelectionRange(len,len);
}

function updateSlashMenu(val){
  if(pwMode)return;
  if(val===''||val==='/'){
    if(val==='/')openSlashMenu('');
    else closeSlashMenu();
    return;
  }
  if(val.startsWith('/')){
    openSlashMenu(val);
  }else{
    closeSlashMenu();
  }
}

// ‚îÄ‚îÄ COMMANDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const customCmds=JSON.parse(localStorage.getItem('amallo_cmds')||'{}');
function saveCustomCmds(){localStorage.setItem('amallo_cmds',JSON.stringify(customCmds));}

async function handleCmd(raw){
  const cmd=raw.trim();const lower=cmd.toLowerCase();
  document.getElementById('connect-card').classList.remove('visible');
  closeSlashMenu();
  addLine('‚ùØ '+cmd,'user');

  if(lower==='clear'){out.innerHTML='';return}

  if(lower==='help'){
    await addLine('‚îÄ‚îÄ‚îÄ CONNECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','sep');
    await addLine('  /connect user@host     SSH into your machine','info');
    await addLine('  /demo                  shared demo node','info');
    await addLine('  /disconnect            return to connect screen','info');
    await addLine('‚îÄ‚îÄ‚îÄ INTERACT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','sep');
    await addLine('  /status                node health + models','info');
    await addLine('  /models                list + pick model (‚Üë‚Üì Enter)','info');
    await addLine('  /model [name]          switch model directly','info');
    await addLine('  /exec [cmd]            run shell on connected machine','info');
    await addLine('  /save [name]           download last AI response','info');
    await addLine('  /addcmd [name] [what]  create shortcut','info');
    await addLine('‚îÄ‚îÄ‚îÄ OPERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','sep');
    await addLine('  /omni [message]        broadcast to all terminals','info');
    await addLine('  /omni clear            clear broadcast','info');
    await addLine('  Ctrl+Shift+Space       toggle ‚ö° spam-enter mode','info');
    await addLine('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','sep');
    await addLine('  Type / to browse all commands with descriptions','info');
    return;
  }

  if(lower.startsWith('connect ')){
    const target=cmd.slice(8).trim();
    let user='root',host=target,port=22;
    if(target.includes('@')){[user,host]=target.split('@');}
    if(host.includes(':')){const p=host.split(':');host=p[0];port=parseInt(p[1]);}
    if(!host){await addLine('Usage: connect user@host[:port]','warning');return;}
    await addLine(`Connecting to ${user}@${host}:${port}...`,'info');
    enterPwMode('SSH password:', async(password)=>{
      exitPwMode();
      await addLine('Authenticating...','info');
      try{
        const r=await fetch(BASE+'/amallo/ssh/connect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({host,user,password,port})});
        const d=await r.json();
        if(d.connected){
          sshSession={id:d.session_id,host:d.host,user:d.user};demoMode=false;
          document.getElementById('ssh-pill').style.display='flex';
          document.getElementById('ssh-label').textContent=`${user}@${host}`.slice(0,14).toUpperCase();
          document.getElementById('nb-host').textContent=`${user}@${host} ¬∑ YOUR MACHINE`;
          document.getElementById('prompt-sym').className='prompt-symbol ssh-mode';
          input.placeholder='run command on your machine  or  / for menu';
          await addLine(`‚úî Connected ‚Äî ${d.user}@${d.host}`,'success');
          await addLine('  Inference routes to your machine.','info');
          await addLine('  Just chat ‚Äî or exec [cmd] for raw shell','info');
        }else{
          const err=d.error||'Connection failed';
          await addLine('‚úó '+err,'error');
          // Detect SSH-not-running vs bad password
          if(err.toLowerCase().includes('refused')||err.toLowerCase().includes('timed out')||err.toLowerCase().includes('no route')){
            await addLine('','info');
            await addLine('  SSH server is not running on that machine.','warning');
            await addLine('  Enable it ‚Äî pick your OS:','info');
            await addLine('','info');
            await addLine('  WINDOWS (PowerShell as Admin):','system');
            await addLine('    Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0','info');
            await addLine('    Start-Service sshd','info');
            await addLine('    Set-Service -Name sshd -StartupType Automatic','info');
            await addLine('','info');
            await addLine('  MAC:','system');
            await addLine('    System Settings ‚Üí General ‚Üí Sharing ‚Üí Remote Login ‚Üí ON','info');
            await addLine('','info');
            await addLine('  LINUX:','system');
            await addLine('    sudo apt install openssh-server','info');
            await addLine('    sudo systemctl enable --now ssh','info');
            await addLine('','info');
            await addLine('  Then retry: /connect '+user+'@'+host,'warning');
            await addLine('','info');
            await addLine('  (Still using shared demo node while you set up)','info');
          }else if(err.toLowerCase().includes('auth')){
            await addLine('  Wrong password or username ‚Äî check and try again.','warning');
          }
        }
      }catch(e){await addLine('‚úó '+e.message,'error');}
    });
    return;
  }

  if(lower==='demo'){
    await addLine('Connecting to shared demo node...','info');
    try{
      if(!SOV_KEY){
        const r=await fetch(BASE+'/amallo/keys/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({identity:'guest-'+Math.random().toString(36).slice(2,6),role:'user'})});
        const d=await r.json();
        SOV_KEY=d.key;localStorage.setItem('amallo_key',SOV_KEY);
      }
      demoMode=true;sshSession=null;
      document.getElementById('ssh-pill').style.display='none';
      document.getElementById('node-label').textContent='DEMO NODE';
      document.getElementById('nb-host').textContent='axismundi.fun ¬∑ shared demo node';
      document.getElementById('prompt-sym').className='prompt-symbol';
      input.placeholder='ask anything ‚Äî running on shared node...';
      await addLine('‚úî Demo node ready. Type anything to chat.','success');
      await addLine('  connect user@yourserver to use your own machine','info');
    }catch(e){await addLine('‚úó '+e.message,'error');}
    return;
  }

  if(lower==='disconnect'){
    if(sshSession){
      try{await fetch(BASE+'/amallo/ssh/disconnect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sshSession.id})});}catch{}
      sshSession=null;
      document.getElementById('ssh-pill').style.display='none';
      document.getElementById('nb-host').textContent='axismundi.fun ¬∑ amallo-controller';
      document.getElementById('prompt-sym').className='prompt-symbol';
      input.placeholder='type / for commands, or connect user@host';
      document.getElementById('connect-card').classList.add('visible');
      await addLine('‚úî Disconnected.','success');
    }else{await addLine('Not connected to a remote machine.','warning');}
    return;
  }

  if(lower.startsWith('exec ')){
    if(!sshSession){await addLine('‚úó Not connected ‚Äî type: connect user@yourserver','error');return;}
    const shellCmd=cmd.slice(5).trim();
    addLine('Running on '+sshSession.user+'@'+sshSession.host+'...','info');
    try{
      const r=await fetch(BASE+'/amallo/ssh/exec',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sshSession.id,cmd:shellCmd})});
      const d=await r.json();
      if(d.error){await addLine('‚úó '+d.error,'error');return;}
      if(d.stdout&&d.stdout.trim())d.stdout.trim().split('\n').forEach(l=>addLine(l,'success'));
      if(d.stderr&&d.stderr.trim())d.stderr.trim().split('\n').forEach(l=>addLine(l,'warning'));
    }catch(e){await addLine('‚úó '+e.message,'error');}
    return;
  }

  if(lower==='status'){
    if(!SOV_KEY&&!sshSession){await addLine('Type demo or connect user@host first','warning');return;}
    if(sshSession){
      await addLine('‚îÄ‚îÄ REMOTE NODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','sep');
      await addLine('  Host:    '+sshSession.user+'@'+sshSession.host,'success');
      await addLine('  Session: '+sshSession.id.slice(0,16)+'...','info');
      await addLine('  Mode:    SSH ‚Üí your compute','success');
      return;
    }
    try{
      const r=await fetch(BASE+'/amallo/status',{headers:{'Authorization':'Bearer '+SOV_KEY}});
      const d=await r.json();
      await addLine('‚îÄ‚îÄ DEMO NODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ','sep');
      await addLine('  Host:    '+d.host,'info');
      await addLine('  Model:   '+d.model,'info');
      await addLine('  RAM:     '+d.ram_gb+'GB / '+d.cpus+' cores','info');
      await addLine('  Disk:    '+d.disk_free_gb+' GB free','info');
      await addLine('  SSH sessions active: '+(d.ssh_sessions_active||0),'info');
      (d.models_available||[]).forEach(m=>addLine('    ‚óÜ '+m,'info'));
    }catch(e){await addLine('‚úó '+e.message,'error');}
    return;
  }

  if(lower==='models'){
    const key=SOV_KEY||'demo';
    if(!SOV_KEY&&!sshSession){await addLine('Type demo or connect user@host first','warning');return;}
    try{
      const r=await fetch(BASE+'/v1/models',{headers:{'Authorization':'Bearer '+key}});
      const d=await r.json();const list=(d.data||[]).map(m=>m.id);
      if(list.length){await addLine('‚Üë‚Üì navigate ¬∑ ENTER select ¬∑ ESC close','info');openModelSelector(list);}
      else await addLine('No models listed','warning');
    }catch(e){await addLine('‚úó '+e.message,'error');}
    return;
  }

  if(lower.startsWith('model ')){
    const name=cmd.slice(6).trim();currentModel=name;
    document.getElementById('model-label').textContent=name.split(':')[0].split('-')[0].toUpperCase().slice(0,8);
    if(SOV_KEY){
      try{const r=await fetch(BASE+'/amallo/model',{method:'POST',headers:{'Authorization':'Bearer '+SOV_KEY,'Content-Type':'application/json'},body:JSON.stringify({model:name})});const d=await r.json();if(d.model)currentModel=d.model;}catch{}
    }
    await addLine('‚úî Model: '+name,'success');return;
  }

  if(lower.startsWith('omni')){
    const rest=cmd.slice(4).trim();
    const clearing=rest==='clear'||rest==='off';
    const text=clearing?'':rest;
    if(!clearing&&!text){await addLine('Usage: /omni [message]  or  /omni clear','warning');return;}
    enterPwMode('Admin password:', async(pw)=>{
      exitPwMode();
      try{
        const r=await fetch(BASE+'/amallo/omni',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,admin_password:pw})});
        const d=await r.json();
        if(d.broadcast!==undefined)await addLine(clearing?'‚úî Broadcast cleared':'‚úî Broadcast sent to all terminals','success');
        else await addLine('‚úó '+(d.error||'Wrong password'),'error');
      }catch(e){await addLine('‚úó '+e.message,'error');}
    });
    return;
  }

  if(lower.startsWith('/addcmd')){
    const parts=cmd.slice(7).trim().split(' ');const name=parts[0];const action=parts.slice(1).join(' ');
    if(!name||!action){await addLine('Usage: /addcmd [name] [action]','warning');return;}
    customCmds[name.toLowerCase()]={action,created:Date.now()};saveCustomCmds();
    await addLine('‚úî Shortcut /'+name+' ‚Üí "'+action+'"','success');return;
  }

  const customKey=lower.startsWith('/')?lower.slice(1).split(' ')[0]:null;
  if(customKey&&customCmds[customKey]){
    const action=customCmds[customKey].action;await addLine('‚ñ∂ '+action,'info');
    await handleCmd(action+' '+cmd.slice(customKey.length+1).trim());return;
  }

  if(lower.startsWith('save')||lower.startsWith('download')){
    const fname=cmd.split(' ')[1]||'amallo-output';
    if(!lastAIText){await addLine('‚úó No AI response to save yet','error');return;}
    addDownloadLine(lastAIText,fname);await addLine('‚úî Click the link above to download','success');return;
  }

  // ‚îÄ‚îÄ INFERENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!sshSession&&!SOV_KEY){
    await addLine('Type  /connect user@yourserver  to use your machine','warning');
    await addLine('  or  /demo  to try the shared node','info');
    document.getElementById('connect-card').classList.add('visible');return;
  }

  const thinkLine=document.createElement('div');thinkLine.className='line info';thinkLine.textContent='‚óà thinking';out.appendChild(thinkLine);
  const pingStart=Date.now();
  const thinking=setInterval(()=>{thinkLine.textContent='‚óà thinking'+'.'.repeat((Date.now()/300|0)%4);out.scrollTop=out.scrollHeight;},100);

  try{
    let url,fetchBody,fetchHeaders;
    if(sshSession){
      url=BASE+'/amallo/ssh/infer';
      fetchBody=JSON.stringify({session_id:sshSession.id,messages:[{role:'user',content:cmd}],model:currentModel,max_tokens:1024});
      fetchHeaders={'Content-Type':'application/json'};
    }else{
      url=BASE+'/v1/chat/completions';
      fetchBody=JSON.stringify({model:'current',messages:[{role:'user',content:cmd}],max_tokens:1024});
      fetchHeaders={'Authorization':'Bearer '+SOV_KEY,'Content-Type':'application/json'};
    }
    const r=await fetch(url,{method:'POST',headers:fetchHeaders,body:fetchBody});
    const d=await r.json();
    clearInterval(thinking);thinkLine.remove();
    if(d.error){await addLine('‚úó '+d.error,'error');if(d.hint)await addLine('  '+d.hint,'info');return;}
    const ms=Date.now()-pingStart;
    const reply=d.choices?.[0]?.message?.content||JSON.stringify(d);
    lastAIText=reply;
    await typeWriter(reply,'ai');
    if(reply.includes('#!/')||(reply.includes('\n')&&(reply.includes('def ')||reply.includes('function ')||reply.includes('apt ')||reply.includes('pip ')))){addDownloadLine(reply,'amallo-script');}
    await addLine('  ['+( d.node||d.model||'amallo')+' ¬∑ '+ms+'ms]','info');
  }catch(e){clearInterval(thinking);thinkLine.remove();await addLine('‚úó '+e.message,'error');}
}

// ‚îÄ‚îÄ SPAM MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let spamMode=false,spamInterval=null;
function setSpamMode(on){
  spamMode=on;
  const ind=document.getElementById('spam-indicator');
  ind.style.display=on?'flex':'none';
  if(on){spamInterval=setInterval(()=>{const v=input.value.trim();if(v){cmdHistory.unshift(v);if(cmdHistory.length>100)cmdHistory.pop();localStorage.setItem('amallo_history',JSON.stringify(cmdHistory));histIdx=-1;input.value='';inputArea.classList.remove('typing');handleCmd(v);}},800);}
  else{clearInterval(spamInterval);spamInterval=null;}
}

// ‚îÄ‚îÄ INPUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const input=document.getElementById('cmd-input');
const inputArea=document.getElementById('input-area');

input.addEventListener('input',()=>{
  if(input.value)inputArea.classList.add('typing');else inputArea.classList.remove('typing');
  if(!pwMode)updateSlashMenu(input.value);
});

input.addEventListener('keydown',async e=>{
  // slash menu navigation takes priority
  if(slashOpen){
    const items=document.querySelectorAll('.sm-item');
    if(e.key==='ArrowDown'){e.preventDefault();slashIdx=Math.min(slashIdx+1,slashFiltered.length-1);items.forEach((it,i)=>it.classList.toggle('focused',i===slashIdx));items[slashIdx]?.scrollIntoView({block:'nearest'});return;}
    if(e.key==='ArrowUp'){e.preventDefault();slashIdx=Math.max(slashIdx-1,0);items.forEach((it,i)=>it.classList.toggle('focused',i===slashIdx));items[slashIdx]?.scrollIntoView({block:'nearest'});return;}
    if(e.key==='Enter'){e.preventDefault();if(slashFiltered[slashIdx])selectSlashCmd(slashFiltered[slashIdx]);return;}
    if(e.key==='Escape'){closeSlashMenu();return;}
    if(e.key==='Tab'){e.preventDefault();if(slashFiltered[slashIdx])selectSlashCmd(slashFiltered[slashIdx]);return;}
  }

  if(e.key==='Enter'){
    const v=input.value;if(!v.trim())return;
    if(pwMode){const cb=pwCallback,val=v;input.value='';exitPwMode();if(cb)await cb(val);return;}
    cmdHistory.unshift(v.trim());if(cmdHistory.length>100)cmdHistory.pop();
    localStorage.setItem('amallo_history',JSON.stringify(cmdHistory));
    histIdx=-1;input.value='';inputArea.classList.remove('typing');
    await handleCmd(v);
  }else if(!pwMode&&e.key==='ArrowUp'&&!slashOpen){
    e.preventDefault();if(histIdx<cmdHistory.length-1){histIdx++;input.value=cmdHistory[histIdx];}
  }else if(!pwMode&&e.key==='ArrowDown'&&!slashOpen){
    e.preventDefault();if(histIdx>0){histIdx--;input.value=cmdHistory[histIdx];}else{histIdx=-1;input.value='';}
  }else if(e.key==='Escape'){
    closeSlashMenu();
  }
});

document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.shiftKey&&e.code==='Space'){e.preventDefault();setSpamMode(!spamMode);addLine(spamMode?'‚ö° SPAM MODE ‚Äî Ctrl+Shift+Space to stop':'‚ñ† Spam mode off',spamMode?'warning':'info');return;}
  if(document.activeElement!==input&&!e.ctrlKey&&!e.metaKey&&e.key.length===1)input.focus();
});

// click outside closes slash menu
document.addEventListener('mousedown',e=>{
  if(slashOpen&&!document.getElementById('slash-menu').contains(e.target)&&e.target!==input)closeSlashMenu();
});

// ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeDownloadLink(text,suggestedName){
  const ext=text.trim().startsWith('#!/')?text.split('\n')[0].includes('python')?'.py':'.sh':text.includes('def ')||text.includes('import ')?'.py':text.includes('function ')||text.includes('const ')?'.js':'.txt';
  const fname=(suggestedName||'amallo-script')+ext;
  const blob=new Blob([text],{type:'text/plain'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=fname;a.className='dl-btn';a.innerHTML='‚¨á '+fname;
  a.addEventListener('click',()=>setTimeout(()=>URL.revokeObjectURL(url),2000));return a;
}
function addDownloadLine(text,name){
  const w=document.createElement('div');w.style.paddingLeft='16px';w.appendChild(makeDownloadLink(text,name));out.appendChild(w);out.scrollTop=out.scrollHeight;
}

// ‚îÄ‚îÄ MODEL SELECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let selectorOpen=false,selectorModels=[],selectorIdx=0;
function openModelSelector(modelList){
  selectorModels=modelList;selectorIdx=0;
  const sel=document.getElementById('model-selector');
  sel.innerHTML=`<div class="model-selector-header"><span>SELECT MODEL</span><span style="color:rgba(255,255,255,0.3)">‚Üë‚Üì ¬∑ ENTER ¬∑ ESC</span></div>`;
  modelList.forEach((m,i)=>{
    const item=document.createElement('div');item.className='model-item'+(i===0?' focused':'');item.dataset.idx=i;
    item.innerHTML=`<div class="check">${m===currentModel?'‚úì':''}</div><span>${m}</span>`;
    item.addEventListener('click',()=>{selectModel(m);closeModelSelector();});sel.appendChild(item);
  });
  sel.classList.add('open');selectorOpen=true;document.addEventListener('keydown',modelKeyHandler);
}
function closeModelSelector(){document.getElementById('model-selector').classList.remove('open');selectorOpen=false;document.removeEventListener('keydown',modelKeyHandler);input.focus();}
function modelKeyHandler(e){
  if(!selectorOpen)return;const items=document.querySelectorAll('.model-item');
  if(e.key==='ArrowDown'){e.preventDefault();selectorIdx=Math.min(selectorIdx+1,selectorModels.length-1);}
  else if(e.key==='ArrowUp'){e.preventDefault();selectorIdx=Math.max(selectorIdx-1,0);}
  else if(e.key==='Enter'){e.preventDefault();selectModel(selectorModels[selectorIdx]);closeModelSelector();return;}
  else if(e.key==='Escape'){closeModelSelector();return;}
  items.forEach((it,i)=>it.classList.toggle('focused',i===selectorIdx));items[selectorIdx]?.scrollIntoView({block:'nearest'});
}
async function selectModel(name){
  currentModel=name;document.getElementById('model-label').textContent=name.split(':')[0].split('-')[0].toUpperCase().slice(0,8);
  if(SOV_KEY){try{const r=await fetch(BASE+'/amallo/model',{method:'POST',headers:{'Authorization':'Bearer '+SOV_KEY,'Content-Type':'application/json'},body:JSON.stringify({model:name})});const d=await r.json();if(d.model)currentModel=d.model;}catch{}}
  await addLine('‚úî Model: '+name,'success');
}

// ‚îÄ‚îÄ TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUtterance=null;
function speakText(text,btn){
  if(!window.speechSynthesis)return;
  if(currentUtterance){window.speechSynthesis.cancel();document.querySelectorAll('.play-btn.speaking').forEach(b=>b.classList.remove('speaking'));if(currentUtterance._btn===btn){currentUtterance=null;return;}}
  const utter=new SpeechSynthesisUtterance(text);utter._btn=btn;utter.rate=1.05;utter.pitch=0.9;
  const voices=window.speechSynthesis.getVoices();
  const preferred=voices.find(v=>v.name.includes('Google UK English Male'))||voices.find(v=>v.name.toLowerCase().includes('male'))||voices[0];
  if(preferred)utter.voice=preferred;
  utter.onstart=()=>{btn.textContent='‚èπ';btn.classList.add('speaking');};
  utter.onend=()=>{btn.textContent='‚ñ∂';btn.classList.remove('speaking');currentUtterance=null;};
  utter.onerror=()=>{btn.textContent='‚ñ∂';btn.classList.remove('speaking');currentUtterance=null;};
  currentUtterance=utter;window.speechSynthesis.speak(utter);
}

// ‚îÄ‚îÄ STT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const micBtn=document.getElementById('mic-btn');
let recognition=null,isListening=false;
function initSTT(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){micBtn.style.opacity='0.3';micBtn.style.cursor='not-allowed';return;}
  recognition=new SR();recognition.continuous=false;recognition.interimResults=true;recognition.lang='en-US';
  recognition.onstart=()=>{isListening=true;micBtn.classList.add('listening');micBtn.textContent='üî¥';input.placeholder='listening...';};
  recognition.onresult=(e)=>{let interim='',final='';for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal)final+=e.results[i][0].transcript;else interim+=e.results[i][0].transcript;}input.value=(final||interim).trim();inputArea.classList.add('typing');};
  recognition.onend=()=>{
    isListening=false;micBtn.classList.remove('listening');micBtn.textContent='üéô';
    input.placeholder=sshSession?'run command on your machine  or  / for menu':'type / for commands, or connect user@host';
    const v=input.value.trim();
    if(v){cmdHistory.unshift(v);if(cmdHistory.length>100)cmdHistory.pop();localStorage.setItem('amallo_history',JSON.stringify(cmdHistory));histIdx=-1;input.value='';inputArea.classList.remove('typing');handleCmd(v);}
  };
  recognition.onerror=(e)=>{isListening=false;micBtn.classList.remove('listening');micBtn.textContent='üéô';if(e.error!=='no-speech')addLine('‚úó mic: '+e.error,'error');};
}
micBtn.addEventListener('click',()=>{if(!recognition)initSTT();if(!recognition)return;if(isListening)recognition.stop();else try{recognition.start();}catch(e){addLine('‚úó mic: '+e.message,'error');}});
initSTT();

// ‚îÄ‚îÄ OMNI POLL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let lastOmniTs=0;
async function pollOmni(){
  try{
    const r=await fetch(BASE+'/amallo/omni',{cache:'no-store'});const d=await r.json();
    const panel=document.getElementById('omni-panel');
    if(d.active&&d.text){
      document.getElementById('omni-text').textContent=d.text;
      document.getElementById('omni-meta').textContent='FROM: '+(d.from||'AXIS').toUpperCase()+' ¬∑ '+new Date(d.ts*1000).toLocaleTimeString();
      panel.classList.add('active');
    }else{panel.classList.remove('active');}
  }catch{}
}
document.getElementById('omni-close').addEventListener('click',()=>document.getElementById('omni-panel').classList.remove('active'));
pollOmni();setInterval(pollOmni,4000);

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
boot();
</script>
</body>
</html>
